<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026北海道行程規劃器</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Font Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <!-- 引入 Google Material Icons (用於加號 FAB) -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot, getDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 設定 Firebase Debug Log
        setLogLevel('silent'); 

        // 全域變數 - 優先使用環境變數，若無則使用預設值
        const appId = typeof __app_id !== 'undefined' ? __app_id : '2026hokkaido';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; 
        
        // --- ⚠️ 重要：請填入您的 Firebase 設定 ---
        const firebaseConfig = {
            apiKey: "AIzaSyBsHR53LDslQL5D9_l79wJA7NUOe8mrCe8",
            authDomain: "hokkaido-fc132.firebaseapp.com",
            projectId: "hokkaido-fc132",
            storageBucket: "hokkaido-fc132.firebasestorage.app",
            messagingSenderId: "107783904784",
            appId: "1:107783904784:web:3635a0aca3fd8478a03495",
        };
        
        let app, db, auth;
        let userId = null;
        let isAuthReady = false;
        
        // 初始化 Firebase
        if (Object.keys(firebaseConfig).length > 0) {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
            } catch (e) {
                console.error("Firebase Initialization Error:", e);
                showStatusMessage("Firebase 初始化失敗，請檢查 Config", true);
            }
        } else {
            console.error("Firebase Configuration is missing.");
        }

        /**
         * 顯示狀態訊息的輔助函式
         */
        const showStatusMessage = (htmlContent, isError = false) => {
            const statusMsg = document.getElementById('status-message');
            if (statusMsg) {
                statusMsg.innerHTML = htmlContent;
                statusMsg.classList.remove('hidden');
                if (isError) {
                    statusMsg.className = "fixed bottom-2 left-1/2 transform -translate-x-1/2 bg-red-600 text-white text-sm px-6 py-4 rounded-lg shadow-xl z-40 max-w-md text-center";
                } else {
                    statusMsg.className = "fixed bottom-2 left-1/2 transform -translate-x-1/2 bg-yellow-600 text-white text-sm px-4 py-2 rounded-lg shadow-xl z-40";
                }
            }
        };

        /**
         * 顯示權限錯誤教學模態框
         */
        const showPermissionErrorModal = () => {
            const modal = document.getElementById('permission-modal');
            modal.classList.remove('hidden');
        };

        /**
         * 處理 Firebase 認證和初始化
         */
        const initFirebase = async () => {
            if (!app || !db || !auth) {
                console.error("Firebase services are not available.");
                return;
            }

            try {
                // 嘗試使用環境提供的 Custom Token 登入
                if (initialAuthToken) {
                    try {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Signed in with custom token");
                    } catch (tokenError) {
                        // 如果 Token 驗證失敗 (例如：專案不匹配)，則自動降級為匿名登入
                        console.warn("Custom token mismatch or invalid, falling back to anonymous auth...", tokenError);
                        await signInAnonymously(auth);
                        console.log("Signed in anonymously (fallback)");
                    }
                } else {
                    // 若無 Token，直接匿名登入
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously");
                }
            } catch (error) {
                console.error("Firebase Authentication failed:", error);
                
                let errorMsg = `認證失敗 (${error.code}): ${error.message}`;
                
                if (error.code === 'auth/configuration-not-found' || error.code === 'auth/operation-not-allowed') {
                     errorMsg = `
                        <strong>⚠️ 認證設定未啟用</strong><br/>
                        請前往 Firebase Console > Build > Authentication > Sign-in method<br/>
                        並啟用 <b>Anonymous (匿名)</b> 登入選項。
                     `;
                } else if (error.code === 'auth/api-key-not-valid-please-pass-a-valid-api-key') {
                    errorMsg = `<strong>⚠️ API Key 無效</strong><br/>請檢查 firebaseConfig 中的 apiKey 是否正確。`;
                }
                
                showStatusMessage(errorMsg, true);
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    // 初始化時載入第一個日期
                    loadItinerary(window.selectedDate);
                    console.log(`User authenticated. UID: ${userId}`);
                    // 顯示用戶ID
                    document.getElementById('user-id-display').textContent = `使用者 ID: ${userId}`;
                    
                    // 認證成功，若之前有顯示認證失敗訊息則隱藏
                    const statusMsg = document.getElementById('status-message');
                    if (statusMsg && statusMsg.textContent.includes('認證失敗')) {
                        statusMsg.classList.add('hidden');
                    }

                    // 認證成功後才開始初始化資料
                    initializeInitialData();

                } else {
                    userId = null;
                    isAuthReady = true;
                    console.log("User signed out or anonymous.");
                }
            });
        };

        // 導航到用戶數據的集合路徑
        const getItineraryCollectionPath = () => {
            if (!userId) return null;
            // 私人數據路徑： /artifacts/{appId}/users/{userId}/hokkaido_itinerary
            return `artifacts/${appId}/users/${userId}/hokkaido_itinerary`;
        };

        // --- 地圖連結功能 ---

        window.openGoogleMapsRoute = () => {
            const items = window.currentItinerary || [];
            const locations = items
                .filter(item => item.location && item.location.trim() !== "")
                .sort((a, b) => (a.time || '').localeCompare(b.time || ''))
                .map(item => item.location.trim());

            if (locations.length === 0) { alert("目前行程中沒有任何地點資訊，無法建立路線。"); return; }

            let url = "";
            if (locations.length === 1) {
                const query = encodeURIComponent(locations[0]);
                url = `https://www.google.com/maps/search/?api=1&query=${query}`;
            } else {
                const origin = encodeURIComponent(locations[0]);
                const destination = encodeURIComponent(locations[locations.length - 1]);
                let waypoints = "";
                if (locations.length > 2) {
                    const waypointList = locations.slice(1, locations.length - 1).map(loc => encodeURIComponent(loc));
                    waypoints = `&waypoints=${waypointList.join('|')}`;
                }
                url = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}${waypoints}`;
            }
            window.open(url, '_blank');
        };

        // --- Firestore 邏輯 ---

        const loadItinerary = (date) => {
            const itineraryContainer = document.getElementById('itinerary-list');
            itineraryContainer.innerHTML = '<div class="text-gray-500 p-4">載入中...</div>';

            if (!isAuthReady || !userId) return;

            const path = getItineraryCollectionPath();
            if (!path) return;

            const docId = date.replace('/', '-'); 
            const docRef = doc(db, path, docId);
            
            window.itineraryUnsubscribe = onSnapshot(docRef, (docSnap) => {
                const itineraryList = docSnap.exists() ? docSnap.data().items : [];
                window.currentItinerary = itineraryList;
                renderItinerary(itineraryList);
                updateMapButtonState(itineraryList);
            }, (error) => {
                console.error("Error fetching itinerary:", error);
                
                if (error.code === 'permission-denied') {
                    showPermissionErrorModal();
                } else if (error.message.includes('offline')) {
                    showStatusMessage(`<strong>⚠️ 無法連接資料庫</strong><br/>請前往 Firebase Console 建立 <strong>Cloud Firestore</strong> 資料庫。`, true);
                }
                
                itineraryContainer.innerHTML = `<div class="text-red-400 p-4">載入失敗，請檢查資料庫連線或權限。</div>`;
            });
        };

        const updateMapButtonState = (items) => {
            const btn = document.getElementById('google-map-btn');
            const hasLocations = items.some(item => item.location && item.location.trim() !== "");
            if (hasLocations) {
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
                btn.disabled = false;
                btn.innerHTML = `<span class="material-icons mr-2">map</span>在 Google 地圖查看路線`;
            } else {
                btn.classList.add('opacity-50', 'cursor-not-allowed');
                btn.disabled = true;
                btn.innerHTML = `<span class="material-icons mr-2">map</span>無地點資訊`;
            }
        };

        const renderItinerary = (items) => {
            const itineraryContainer = document.getElementById('itinerary-list');
            itineraryContainer.innerHTML = '';

            if (items.length === 0) {
                itineraryContainer.innerHTML = `
                    <div class="text-center p-8 bg-gray-900 rounded-xl">
                        <p class="text-lg text-gray-400 mb-2">本日行程尚未安排</p>
                        <p class="text-sm text-gray-500">點擊右下角 '+' 新增活動</p>
                    </div>
                `;
                return;
            }

            items.sort((a, b) => (a.time || '').localeCompare(b.time || ''));

            items.forEach((item, index) => {
                const card = document.createElement('div');
                card.className = 'bg-gray-900 p-4 rounded-xl shadow-lg border-l-4 border-amber-500 hover:bg-gray-800 transition duration-150 ease-in-out cursor-pointer group';
                
                const locationDisplay = item.location ? 
                    `<p class="text-sm text-gray-400 italic mt-1 flex items-center">${item.location}</p>` : 
                    `<p class="text-sm text-gray-500 italic mt-1">無地點</p>`;

                const mapBtnHtml = item.location ? `
                    <button class="map-item-btn text-gray-500 hover:text-amber-400 p-2 rounded-full transition-colors" title="在 Google 地圖中查看">
                        <span class="material-icons text-lg">place</span>
                    </button>
                ` : '';

                const editBtnHtml = `
                    <button class="edit-btn text-gray-500 hover:text-amber-400 p-2 rounded-full transition-colors" data-index="${index}" title="編輯內容">
                        <span class="material-icons text-lg">edit</span>
                    </button>
                `;

                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-grow pr-2">
                            <p class="text-xs font-mono text-amber-400 mb-1">${item.time || 'N/A'}</p>
                            <h3 class="text-xl font-bold text-white mt-1 flex items-center">${item.activity || '無標題活動'}</h3>
                            ${locationDisplay}
                            <p class="text-sm text-gray-300 mt-2 whitespace-pre-wrap">${item.details || '無詳細說明'}</p>
                        </div>
                        <div class="flex items-center space-x-1 opacity-100 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity shrink-0">
                            ${mapBtnHtml}
                            ${editBtnHtml}
                        </div>
                    </div>
                `;
                
                card.addEventListener('click', () => { openEditModal(index); });
                const editBtn = card.querySelector('.edit-btn');
                if (editBtn) { editBtn.addEventListener('click', (e) => { e.stopPropagation(); openEditModal(index); }); }
                const mapBtn = card.querySelector('.map-item-btn');
                if (mapBtn) { mapBtn.addEventListener('click', (e) => { e.stopPropagation(); const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.location)}`; window.open(url, '_blank'); }); }

                itineraryContainer.appendChild(card);
            });
        };

        const saveItinerary = async (date, items) => {
            if (!isAuthReady || !userId) { showStatusMessage('錯誤：尚未完成認證。', true); return; }

            const path = getItineraryCollectionPath();
            if (!path) return;

            const docId = date.replace('/', '-'); 
            const docRef = doc(db, path, docId);
            try {
                await setDoc(docRef, { items: items }, { merge: true });
            } catch (error) {
                console.error("Error saving itinerary:", error);
                if (error.code === 'permission-denied') {
                    showPermissionErrorModal();
                } else {
                    showStatusMessage(`儲存失敗: ${error.message}`, true);
                }
            }
        };

        // --- 模態框 (Modal) 邏輯 ---

        const modal = document.getElementById('itinerary-modal');
        const modalForm = document.getElementById('itinerary-form');
        const modalTitle = document.getElementById('modal-title');
        let editingIndex = null; 

        window.openAddModal = () => {
            editingIndex = null;
            modalTitle.textContent = '新增行程項目';
            modalForm.reset();
            modal.classList.remove('hidden');
        };

        const openEditModal = (index) => {
            editingIndex = index;
            modalTitle.textContent = '編輯行程項目';
            const item = window.currentItinerary[index];
            document.getElementById('time').value = item.time || '';
            document.getElementById('activity').value = item.activity || '';
            document.getElementById('location').value = item.location || '';
            document.getElementById('details').value = item.details || '';
            document.getElementById('delete-btn').classList.remove('hidden');
            modal.classList.remove('hidden');
        };

        window.closeModal = () => {
            modal.classList.add('hidden');
            document.getElementById('delete-btn').classList.add('hidden');
            modalForm.reset();
        };

        modalForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const time = document.getElementById('time').value.trim();
            const activity = document.getElementById('activity').value.trim();
            const location = document.getElementById('location').value.trim();
            const details = document.getElementById('details').value.trim();
            
            if (!activity) { showStatusMessage('活動名稱不能為空。', true); return; }
            
            const newItem = { 
                time, activity, location, details, 
                id: editingIndex !== null ? window.currentItinerary[editingIndex].id : crypto.randomUUID() 
            };
            
            let updatedItems = [...(window.currentItinerary || [])];
            if (editingIndex !== null) { updatedItems[editingIndex] = newItem; } else { updatedItems.push(newItem); }

            await saveItinerary(window.selectedDate, updatedItems);
            window.closeModal();
        });

        document.getElementById('delete-btn').addEventListener('click', async () => {
            if (editingIndex !== null) {
                const updatedItems = [...(window.currentItinerary || [])];
                const confirmMessage = `確定要刪除活動：${updatedItems[editingIndex].activity} 嗎？`;
                const confirmation = await showCustomConfirm(confirmMessage);
                if (confirmation) {
                    updatedItems.splice(editingIndex, 1);
                    await saveItinerary(window.selectedDate, updatedItems);
                    window.closeModal();
                }
            }
        });

        // 複製規則
        window.copyRules = () => {
            const rulesText = document.getElementById('rules-code').innerText;
            navigator.clipboard.writeText(rulesText).then(() => {
                const btn = document.getElementById('copy-rules-btn');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<span class="material-icons text-sm mr-1">check</span>已複製';
                btn.classList.replace('bg-blue-600', 'bg-green-600');
                btn.classList.replace('hover:bg-blue-700', 'hover:bg-green-700');
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.replace('bg-green-600', 'bg-blue-600');
                    btn.classList.replace('hover:bg-green-700', 'hover:bg-blue-700');
                }, 2000);
            });
        };
        
        window.closePermissionModal = () => {
             document.getElementById('permission-modal').classList.add('hidden');
        };

        // --- 日期選擇邏輯 ---

        const dates = ["01/04", "01/05", "01/06", "01/07", "01/08", "01/09", "01/10", "01/11"];
        window.selectedDate = dates[0]; 

        window.selectDate = (date) => {
            if (window.itineraryUnsubscribe) { window.itineraryUnsubscribe(); }
            window.selectedDate = date;
            
            document.querySelectorAll('.date-btn').forEach(btn => {
                btn.classList.remove('bg-amber-600', 'text-white');
                btn.classList.add('bg-gray-900', 'text-amber-400', 'hover:bg-gray-800');
            });
            document.getElementById(`date-${date.replace('/', '-')}`).classList.remove('bg-gray-900', 'text-amber-400', 'hover:bg-gray-800');
            document.getElementById(`date-${date.replace('/', '-')}`).classList.add('bg-amber-600', 'text-white', 'shadow-lg');

            document.getElementById('current-date-title').textContent = `${date} 行程`;
            if (isAuthReady) { loadItinerary(date); }
        };

        document.addEventListener('DOMContentLoaded', () => {
            const dateNav = document.getElementById('date-nav');
            dates.forEach(date => {
                const btn = document.createElement('button');
                btn.id = `date-${date.replace('/', '-')}`;
                btn.className = `date-btn px-4 py-2 rounded-full font-semibold transition duration-150 ease-in-out whitespace-nowrap`;
                btn.innerHTML = `<span class="block text-xs opacity-75">${date.split('/')[0]}月</span><span class="block text-xl">${date.split('/')[1]}日</span>`;
                btn.onclick = () => window.selectDate(date);
                dateNav.appendChild(btn);
            });
            window.selectDate(window.selectedDate); 
            initFirebase();
        });

        /**
         * 初始化範例數據（僅在文件不存在時寫入）
         */
        const initializeInitialData = async () => {
            if (!isAuthReady || !userId) return;

            const path = getItineraryCollectionPath();
            if (!path) return;

            const initialData = {
                "01/04": [
                    { time: "14:00", activity: "抵達新千歲機場 (CTS)", location: "新千歲機場", details: "辦理入境手續。\n搭乘 JR 快速 Airport 線至札幌。", id: crypto.randomUUID() },
                    { time: "17:00", activity: "札幌市區 Check-in", location: "JR 札幌站", details: "放下行李，準備外出用餐。", id: crypto.randomUUID() },
                    { time: "19:30", activity: "晚餐：札幌拉麵橫丁", location: "拉麵橫丁", details: "品嚐味噌拉麵，感受札幌冬夜的溫暖。", id: crypto.randomUUID() }
                ],
                "01/05": [
                    { time: "10:00", activity: "前往小樽運河", location: "小樽運河", details: "從札幌搭乘 JR 約 40 分鐘。冬季運河旁有積雪。", id: crypto.randomUUID() },
                    { time: "12:30", activity: "午餐：小樽壽司街", location: "小樽壽司通", details: "選擇一家老字號壽司店。", id: crypto.randomUUID() },
                    { time: "15:00", activity: "北一硝子館與八音盒館", location: "北一硝子", details: "參觀玻璃工藝品和充滿懷舊氣息的音樂盒。", id: crypto.randomUUID() },
                    { time: "18:00", activity: "返回札幌", location: "札幌站", details: "在站前大丸百貨逛逛。", id: crypto.randomUUID() }
                ],
                "01/06": [
                    { time: "10:30", activity: "札幌地標巡禮", location: "札幌時計台", details: "在雪景中拍照留念。", id: crypto.randomUUID() },
                    { time: "12:30", activity: "午餐：二條市場", location: "二條市場", details: "享用新鮮海鮮蓋飯。", id: crypto.randomUUID() },
                    { time: "15:00", activity: "大通公園與電視塔", location: "大通公園", details: "為即將到來的札幌雪祭勘景。", id: crypto.randomUUID() },
                    { time: "19:00", activity: "晚餐：成吉思汗烤羊肉", location: "薄野", details: "品嚐北海道的特色烤羊肉 (Genghis Khan BBQ)。", id: crypto.randomUUID() }
                ]
            };

            let hasError = false;
            for (const date of dates) {
                if (hasError) break; // 若已出錯，停止後續請求

                const docId = date.replace('/', '-'); 
                const docRef = doc(db, path, docId);
                try {
                    const docSnap = await getDoc(docRef);
                    if (!docSnap.exists()) {
                        console.log(`Setting initial data for ${date}.`);
                        await setDoc(docRef, { items: initialData[date] || [] });
                    }
                } catch (error) {
                    // 若偵測到權限錯誤
                    if (error.code === 'permission-denied') {
                        console.error(`Permission Denied at ${date}:`, error);
                        showPermissionErrorModal();
                        hasError = true;
                    } 
                    // 若偵測到離線錯誤
                    else if (error.message.includes('offline') || error.code === 'unavailable') {
                        console.error(`Firebase Offline/Unavailable Error at ${date}:`, error);
                        showStatusMessage(`
                            <strong>⚠️ 無法連接資料庫</strong><br/>
                            請確認您已在 Firebase Console 建立 <strong>Cloud Firestore</strong> 資料庫。<br/>
                            <span class="text-xs">(左側選單 Build > Firestore Database > Create database)</span>
                        `, true);
                        hasError = true;
                    } else {
                        console.error(`Error initializing initial data for ${date}:`, error);
                    }
                }
            }
        };

        // --- 客製化確認彈窗邏輯 ---
        const customConfirmModal = document.getElementById('custom-confirm-modal');
        const confirmMessageEl = document.getElementById('confirm-message');
        const confirmYesBtn = document.getElementById('confirm-yes');
        const confirmNoBtn = document.getElementById('confirm-no');
        let resolveConfirmPromise;

        const showCustomConfirm = (message) => {
            confirmMessageEl.textContent = message;
            customConfirmModal.classList.remove('hidden');
            return new Promise((resolve) => { resolveConfirmPromise = resolve; });
        };

        confirmYesBtn.addEventListener('click', () => {
            customConfirmModal.classList.add('hidden');
            if (resolveConfirmPromise) resolveConfirmPromise(true);
        });

        confirmNoBtn.addEventListener('click', () => {
            customConfirmModal.classList.add('hidden');
            if (resolveConfirmPromise) resolveConfirmPromise(false);
        });

    </script>

    <style>
        body { font-family: 'Inter', sans-serif; transition: background-color 0.3s; }
        ::-webkit-scrollbar { display: none; }
        .itinerary-grid { display: grid; grid-template-columns: 1fr; gap: 1.5rem; position: relative; padding-left: 20px; }
        .itinerary-grid::before { content: ''; position: absolute; top: 0; left: 20px; width: 2px; background-color: #1f2937; z-index: 0; height: 100%; }
        .itinerary-grid > div { position: relative; margin-left: 20px; padding-left: 20px; }
        .itinerary-grid > div::before { content: ''; position: absolute; left: -12px; top: 1.5rem; width: 12px; height: 12px; background-color: #f59e0b; border-radius: 50%; border: 4px solid #030712; z-index: 10; }
        #date-nav { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .markdown-body h1, .markdown-body h2, .markdown-body h3 { color: #fbbf24; font-weight: bold; margin-top: 1em; margin-bottom: 0.5em; }
        .markdown-body p { margin-bottom: 0.8em; line-height: 1.6; }
        .markdown-body ul, .markdown-body ol { padding-left: 1.5em; margin-bottom: 0.8em; }
        .markdown-body li { list-style-type: disc; }
        .markdown-body strong { color: #f59e0b; }
    </style>
</head>
<body class="bg-gray-950 text-white min-h-screen">

    <div class="max-w-4xl mx-auto">
        <div class="sticky top-0 z-50 bg-gray-950 pt-4 sm:pt-8 px-4 sm:px-8 pb-2 shadow-lg border-b border-gray-800/50">
            <header class="mb-4">
                <h1 class="text-3xl sm:text-4xl font-extrabold tracking-tight text-amber-400">2026北海道行程規劃器</h1>
                <p class="text-sm text-gray-400 mt-1" id="user-id-display">使用者 ID: 載入中...</p>
            </header>
            <nav id="date-nav" class="flex space-x-3 p-2 bg-gray-900 rounded-xl shadow-inner"></nav>
        </div>

        <div class="p-4 sm:p-8 pt-6">
            <div class="mb-4">
                <button id="google-map-btn" onclick="openGoogleMapsRoute()" class="w-full bg-gray-900 hover:bg-gray-800 border border-amber-600 text-amber-500 hover:text-amber-400 font-bold py-4 px-4 rounded-xl shadow-lg transition duration-300 flex items-center justify-center">
                    <span class="material-icons mr-2">map</span>在 Google 地圖查看路線
                </button>
            </div>

            <main class="mb-24">
                <h2 id="current-date-title" class="text-2xl font-bold text-white mb-6">01/04 行程</h2>
                <div id="itinerary-list" class="itinerary-grid">
                    <div class="text-gray-500 p-4">載入中...</div>
                </div>
            </main>

            <div id="status-message" class="fixed bottom-2 left-1/2 transform -translate-x-1/2 bg-yellow-600 text-white text-sm px-4 py-2 rounded-lg shadow-xl hidden"></div>

            <button id="add-fab" onclick="openAddModal()"
                class="fixed bottom-8 right-8 bg-amber-500 hover:bg-amber-600 text-white w-14 h-14 flex items-center justify-center rounded-2xl shadow-2xl transition duration-300 ease-in-out transform hover:scale-110 focus:outline-none focus:ring-4 focus:ring-amber-500 focus:ring-opacity-50 z-40">
                <span class="material-icons text-3xl">add</span>
            </button>
        </div>
    </div>

    <!-- 權限錯誤教學模態框 -->
    <div id="permission-modal" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-[70] hidden">
        <div class="bg-white text-gray-900 rounded-xl shadow-2xl w-11/12 max-w-2xl p-6 relative max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold mb-4 text-red-600 flex items-center">
                <span class="material-icons mr-2">gpp_bad</span> 需要設定資料庫權限
            </h3>
            
            <p class="mb-4 text-gray-700">您遇到 <code>Missing or insufficient permissions</code> 錯誤，這代表您的 Firebase 資料庫安全規則尚未設定，拒絕了寫入請求。</p>
            
            <div class="bg-gray-100 p-4 rounded-lg border border-gray-200 mb-4">
                <h4 class="font-bold mb-2 flex items-center text-sm text-gray-600">
                    <span class="material-icons text-sm mr-1">content_copy</span> 請複製以下規則代碼：
                </h4>
                <pre id="rules-code" class="bg-gray-800 text-green-400 p-4 rounded text-sm overflow-x-auto font-mono">rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /artifacts/{appId}/users/{userId}/{document=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
  }
}</pre>
                <button id="copy-rules-btn" onclick="copyRules()" class="mt-2 w-full py-2 bg-blue-600 hover:bg-blue-700 text-white rounded font-bold transition-colors flex items-center justify-center">
                    <span class="material-icons text-sm mr-1">content_copy</span> 複製代碼
                </button>
            </div>
            
            <div class="space-y-2 text-sm text-gray-600">
                <p class="font-bold">設定步驟：</p>
                <ol class="list-decimal list-inside space-y-1 ml-2">
                    <li>前往 <a href="https://console.firebase.google.com/" target="_blank" class="text-blue-600 underline">Firebase Console</a>。</li>
                    <li>點選您的專案 (<strong>hokkaido-fc132</strong>)。</li>
                    <li>左側選單點選 <strong>Build</strong> > <strong>Firestore Database</strong>。</li>
                    <li>點選上方的 <strong>Rules (規則)</strong> 標籤。</li>
                    <li>刪除原本的內容，<strong>貼上</strong>剛剛複製的代碼。</li>
                    <li>點擊 <strong>Publish (發布)</strong> 按鈕。</li>
                </ol>
            </div>

            <div class="mt-6 text-center">
                <button onclick="closePermissionModal()" class="w-full py-3 bg-gray-800 hover:bg-gray-700 text-white rounded-lg transition-colors font-bold">
                    我已完成設定，關閉視窗
                </button>
            </div>
        </div>
    </div>

    <!-- 行程新增/編輯模態框 -->
    <div id="itinerary-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-900 rounded-xl shadow-2xl w-[95%] sm:w-11/12 max-w-lg p-4 sm:p-6 relative">
            <h3 id="modal-title" class="text-2xl font-bold mb-4 text-amber-400">新增行程項目</h3>
            <form id="itinerary-form">
                <div class="mb-4">
                    <label for="time" class="block text-sm font-medium text-gray-300 mb-1">時間 (HH:MM)</label>
                    <input type="time" id="time" class="w-full max-w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white focus:ring-amber-500 focus:border-amber-500 appearance-none">
                </div>
                <div class="mb-4">
                    <label for="activity" class="block text-sm font-medium text-gray-300 mb-1">活動名稱 *</label>
                    <input type="text" id="activity" required class="w-full max-w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white focus:ring-amber-500 focus:border-amber-500">
                </div>
                <div class="mb-4">
                    <label for="location" class="block text-sm font-medium text-gray-300 mb-1">地點</label>
                    <input type="text" id="location" placeholder="例如：札幌電視塔" class="w-full max-w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white focus:ring-amber-500 focus:border-amber-500">
                </div>
                <div class="mb-6">
                    <label for="details" class="block text-sm font-medium text-gray-300 mb-1">詳細說明</label>
                    <textarea id="details" rows="3" class="w-full max-w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white focus:ring-amber-500 focus:border-amber-500"></textarea>
                </div>
                <div class="flex flex-col sm:flex-row justify-between space-y-3 sm:space-y-0 sm:space-x-3">
                    <button type="button" id="delete-btn" class="hidden w-full sm:w-auto px-4 py-3 text-sm font-semibold rounded-lg bg-red-600 hover:bg-red-700 transition duration-150 text-white">刪除</button>
                    <div class="flex space-x-3 w-full sm:w-auto">
                        <button type="button" onclick="closeModal()" class="w-full px-4 py-3 text-sm font-semibold rounded-lg bg-gray-700 hover:bg-gray-600 transition duration-150 text-white">取消</button>
                        <button type="submit" class="w-full px-4 py-3 text-sm font-semibold rounded-lg bg-amber-500 hover:bg-amber-600 transition duration-150 text-white">儲存</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- 客製化確認彈窗 -->
    <div id="custom-confirm-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[60] hidden">
        <div class="bg-gray-900 rounded-xl shadow-2xl w-11/12 max-w-sm p-6">
            <h4 class="text-xl font-bold mb-4 text-red-400">確認操作</h4>
            <p id="confirm-message" class="text-gray-300 mb-6">確定要執行此操作嗎？</p>
            <div class="flex justify-end space-x-3">
                <button id="confirm-no" class="px-4 py-2 text-sm font-semibold rounded-lg bg-gray-700 hover:bg-gray-600 transition duration-150 text-white">取消</button>
                <button id="confirm-yes" class="px-4 py-2 text-sm font-semibold rounded-lg bg-red-600 hover:bg-red-700 transition duration-150 text-white">確認刪除</button>
            </div>
        </div>
    </div>

</body>
</html>
