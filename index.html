<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026北海道行程規劃器</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Font Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <!-- 引入 Google Material Icons (用於加號 FAB) -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- 引入 Marked.js 用於解析 Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot, getDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 設定 Firebase Debug Log
        setLogLevel('Debug');

        // 全域變數
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Gemini API Key (由執行環境注入)
        const apiKey = ""; 

        let app, db, auth;
        let userId = null;
        let isAuthReady = false;
        
        // 初始化 Firebase
        if (Object.keys(firebaseConfig).length > 0) {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } else {
            console.error("Firebase Configuration is missing.");
        }

        /**
         * 處理 Firebase 認證和初始化
         */
        const initFirebase = async () => {
            if (!app || !db || !auth) {
                console.error("Firebase services are not available.");
                return;
            }

            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase Authentication failed:", error);
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    // 初始化時載入第一個日期
                    loadItinerary(window.selectedDate);
                    console.log(`User authenticated. UID: ${userId}`);
                    // 顯示用戶ID
                    document.getElementById('user-id-display').textContent = `使用者 ID: ${userId}`;
                } else {
                    userId = null;
                    isAuthReady = true;
                    console.log("User signed out or anonymous.");
                }
            });
        };

        // 導航到用戶數據的集合路徑
        const getItineraryCollectionPath = () => {
            if (!userId) return null;
            // 私人數據路徑： /artifacts/{appId}/users/{userId}/hokkaido_itinerary
            return `artifacts/${appId}/users/${userId}/hokkaido_itinerary`;
        };

        // --- Gemini AI 功能 ---

        /**
         * 呼叫 Gemini API
         * @param {string} prompt - 給 AI 的提示詞
         */
        const callGeminiAPI = async (prompt) => {
            const aiModal = document.getElementById('ai-modal');
            const aiContent = document.getElementById('ai-content');
            const aiLoading = document.getElementById('ai-loading');
            
            // 顯示 Modal 和 Loading
            aiModal.classList.remove('hidden');
            aiLoading.classList.remove('hidden');
            aiContent.innerHTML = ''; // 清空舊內容

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: prompt }]
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }

                const data = await response.json();
                const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || "抱歉，AI 暫時無法回應，請稍後再試。";
                
                // 使用 marked.js 將 Markdown 轉換為 HTML
                aiContent.innerHTML = marked.parse(aiText);

            } catch (error) {
                console.error("Gemini API Error:", error);
                aiContent.innerHTML = `<p class="text-red-400">發生錯誤：${error.message}</p>`;
            } finally {
                aiLoading.classList.add('hidden');
            }
        };

        /**
         * 功能 1: AI 行程健檢
         */
        window.auditItinerary = () => {
            const items = window.currentItinerary || [];
            const date = window.selectedDate;
            
            if (items.length === 0) {
                alert("目前沒有行程可以分析，請先新增一些活動！");
                return;
            }

            // 建構 Prompt
            let itineraryText = items.map(item => `- ${item.time} ${item.activity} @ ${item.location} (${item.details})`).join('\n');
            const prompt = `
                你是一位專業的北海道旅遊顧問。請幫我檢查我在 ${date} 的這份行程安排：
                
                ${itineraryText}

                請用繁體中文回答，並著重於以下幾點：
                1. **路線順暢度**：地點之間的移動是否合理？
                2. **時間安排**：是否太趕或太鬆？
                3. **實用建議**：有無遺漏的重要注意事項（如交通、營業時間）？
                請用條列式呈現，語氣親切專業。
            `;

            callGeminiAPI(prompt);
        };

        /**
         * 功能 2: AI 推薦周邊
         */
        window.recommendNearby = () => {
            const items = window.currentItinerary || [];
            const date = window.selectedDate;

            // 建構 Prompt
            let itineraryText = items.map(item => `- ${item.time} ${item.activity} @ ${item.location}`).join('\n');
            const prompt = `
                你是一位熟悉北海道的在地嚮導。這是我在 ${date} 的行程：

                ${itineraryText}

                請根據我目前的行程地點和時間空檔，推薦 3 個 **附近的隱藏景點** 或 **在地美食**。
                不要推薦太遠的地方，重點是順路。
                請用繁體中文回答，包含推薦理由。
            `;

            callGeminiAPI(prompt);
        };

        window.closeAIModal = () => {
            document.getElementById('ai-modal').classList.add('hidden');
        };


        // --- 地圖連結功能 ---

        /**
         * 開啟 Google Maps 路線
         * 將當前行程中的所有地點串接起來
         */
        window.openGoogleMapsRoute = () => {
            const items = window.currentItinerary || [];
            // 過濾出有地點名稱的行程，並依照時間排序
            const locations = items
                .filter(item => item.location && item.location.trim() !== "")
                .sort((a, b) => (a.time || '').localeCompare(b.time || ''))
                .map(item => item.location.trim());

            if (locations.length === 0) {
                alert("目前行程中沒有任何地點資訊，無法建立路線。");
                return;
            }

            let url = "";
            if (locations.length === 1) {
                // 如果只有一個地點，直接搜尋該地點
                const query = encodeURIComponent(locations[0]);
                url = `https://www.google.com/maps/search/?api=1&query=${query}`;
            } else {
                // 如果有多個地點，建立導航路線
                // 起點
                const origin = encodeURIComponent(locations[0]);
                // 終點
                const destination = encodeURIComponent(locations[locations.length - 1]);
                
                // 中途點 (waypoints)
                let waypoints = "";
                if (locations.length > 2) {
                    const waypointList = locations.slice(1, locations.length - 1).map(loc => encodeURIComponent(loc));
                    waypoints = `&waypoints=${waypointList.join('|')}`;
                }

                url = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}${waypoints}`;
            }

            // 開啟新視窗
            window.open(url, '_blank');
        };

        // --- Firestore 邏輯 ---

        /**
         * 從 Firestore 載入並監聽指定日期的行程
         * @param {string} date - 日期，格式 MM/DD
         */
        const loadItinerary = (date) => {
            const itineraryContainer = document.getElementById('itinerary-list');
            itineraryContainer.innerHTML = '<div class="text-gray-500 p-4">載入中...</div>';

            if (!isAuthReady || !userId) {
                console.warn("Auth not ready or userId missing. Skipping Firestore read.");
                return;
            }

            const path = getItineraryCollectionPath();
            if (!path) return;

            // 使用連字符替換斜線，以避免 Firestore 將其誤認為路徑分隔符。
            const docId = date.replace('/', '-'); 
            const docRef = doc(db, path, docId);
            
            // 監聽文件變更 (實時更新)
            window.itineraryUnsubscribe = onSnapshot(docRef, (docSnap) => {
                const itineraryList = docSnap.exists() ? docSnap.data().items : [];
                window.currentItinerary = itineraryList;
                renderItinerary(itineraryList);
                updateMapButtonState(itineraryList); // 更新按鈕狀態
            }, (error) => {
                console.error("Error fetching itinerary:", error);
                itineraryContainer.innerHTML = `<div class="text-red-400 p-4">載入行程失敗：${error.message}</div>`;
            });
        };

        /**
         * 更新地圖按鈕的顯示狀態 (如果沒有地點則隱藏或變灰)
         */
        const updateMapButtonState = (items) => {
            const btn = document.getElementById('google-map-btn');
            const hasLocations = items.some(item => item.location && item.location.trim() !== "");
            
            if (hasLocations) {
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
                btn.disabled = false;
                btn.innerHTML = `<span class="material-icons mr-2">map</span>在 Google 地圖查看路線`;
            } else {
                btn.classList.add('opacity-50', 'cursor-not-allowed');
                btn.disabled = true;
                btn.innerHTML = `<span class="material-icons mr-2">map</span>無地點資訊`;
            }
        };

        /**
         * 渲染行程列表到 UI
         * @param {Array} items - 行程項目列表
         */
        const renderItinerary = (items) => {
            const itineraryContainer = document.getElementById('itinerary-list');
            itineraryContainer.innerHTML = '';

            if (items.length === 0) {
                itineraryContainer.innerHTML = `
                    <div class="text-center p-8 bg-gray-900 rounded-xl">
                        <p class="text-lg text-gray-400 mb-2">本日行程尚未安排</p>
                        <p class="text-sm text-gray-500">點擊右下角 '+' 新增活動</p>
                    </div>
                `;
                return;
            }

            // 根據時間排序 (時間格式 HH:MM)
            items.sort((a, b) => (a.time || '').localeCompare(b.time || ''));

            items.forEach((item, index) => {
                const card = document.createElement('div');
                // 使用 amber-500 作為邊線
                card.className = 'bg-gray-900 p-4 rounded-xl shadow-lg border-l-4 border-amber-500 hover:bg-gray-800 transition duration-150 ease-in-out cursor-pointer group';
                
                // 點擊地點開啟單一地點導航
                const locationHtml = item.location ? 
                    `<a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.location)}" target="_blank" class="text-sm text-gray-400 italic flex items-center mt-1 hover:text-amber-400 transition-colors" onclick="event.stopPropagation();">
                        ${item.location} <span class="material-icons text-xs ml-1">launch</span>
                     </a>` : 
                    `<p class="text-sm text-gray-500 italic mt-1">無地點</p>`;

                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-grow">
                            <!-- 時間文字使用 amber-400 -->
                            <p class="text-xs font-mono text-amber-400">${item.time || 'N/A'}</p>
                            <h3 class="text-xl font-bold text-white mt-1 flex items-center">
                                ${item.activity || '無標題活動'}
                            </h3>
                            ${locationHtml}
                            <p class="text-sm text-gray-300 mt-2 whitespace-pre-wrap">${item.details || '無詳細說明'}</p>
                        </div>
                        <!-- 編輯按鈕 hover 時使用 amber-400 -->
                        <button class="edit-btn text-gray-500 hover:text-amber-400 ml-4 p-1 rounded-full opacity-100 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity" data-index="${index}">
                            <span class="material-icons text-lg">edit</span>
                        </button>
                    </div>
                `;
                
                // 點擊整張卡片也可以編輯
                card.addEventListener('click', () => {
                    openEditModal(index);
                });

                itineraryContainer.appendChild(card);
            });

            // 為編輯按鈕添加事件監聽器
            document.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation(); // 防止觸發父級卡片的點擊事件
                    const index = parseInt(button.getAttribute('data-index'));
                    openEditModal(index);
                });
            });
        };

        /**
         * 儲存行程到 Firestore
         * @param {string} date - 日期 MM/DD
         * @param {Array} items - 更新後的行程列表
         */
        const saveItinerary = async (date, items) => {
            if (!isAuthReady || !userId) {
                document.getElementById('status-message').textContent = '錯誤：尚未完成認證。';
                return;
            }

            const path = getItineraryCollectionPath();
            if (!path) return;

            // 使用連字符替換斜線，以避免 Firestore 將其誤認為路徑分隔符。
            const docId = date.replace('/', '-'); 
            const docRef = doc(db, path, docId);
            try {
                await setDoc(docRef, { items: items }, { merge: true });
                // 成功訊息將由 onSnapshot 自動更新 UI 後覆蓋
            } catch (error) {
                console.error("Error saving itinerary:", error);
                document.getElementById('status-message').textContent = `儲存失敗: ${error.message}`;
            }
        };

        // --- 模態框 (Modal) 邏輯 ---

        const modal = document.getElementById('itinerary-modal');
        const modalForm = document.getElementById('itinerary-form');
        const modalTitle = document.getElementById('modal-title');
        let editingIndex = null; // 記錄正在編輯的行程項目索引

        /**
         * 開啟新增行程模態框
         */
        window.openAddModal = () => {
            editingIndex = null;
            modalTitle.textContent = '新增行程項目';
            modalForm.reset();
            modal.classList.remove('hidden');
        };

        /**
         * 開啟編輯行程模態框
         * @param {number} index - 要編輯的行程項目索引
         */
        const openEditModal = (index) => {
            editingIndex = index;
            modalTitle.textContent = '編輯行程項目';
            
            const item = window.currentItinerary[index];
            document.getElementById('time').value = item.time || '';
            document.getElementById('activity').value = item.activity || '';
            document.getElementById('location').value = item.location || '';
            document.getElementById('details').value = item.details || '';
            
            document.getElementById('delete-btn').classList.remove('hidden');
            modal.classList.remove('hidden');
        };

        /**
         * 關閉模態框
         */
        window.closeModal = () => {
            modal.classList.add('hidden');
            document.getElementById('delete-btn').classList.add('hidden');
            modalForm.reset();
        };

        /**
         * 處理表單提交（新增或編輯）
         */
        modalForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const time = document.getElementById('time').value.trim();
            const activity = document.getElementById('activity').value.trim();
            const location = document.getElementById('location').value.trim();
            const details = document.getElementById('details').value.trim();
            
            if (!activity) {
                document.getElementById('status-message').textContent = '活動名稱不能為空。';
                return;
            }
            
            const newItem = { 
                time, 
                activity, 
                location, 
                details, 
                id: editingIndex !== null ? window.currentItinerary[editingIndex].id : crypto.randomUUID() 
            };
            
            let updatedItems = [...(window.currentItinerary || [])];

            if (editingIndex !== null) {
                // 編輯現有項目
                updatedItems[editingIndex] = newItem;
            } else {
                // 新增項目
                updatedItems.push(newItem);
            }

            await saveItinerary(window.selectedDate, updatedItems);
            
            window.closeModal();
        });

        /**
         * 處理刪除按鈕
         */
        document.getElementById('delete-btn').addEventListener('click', async () => {
            if (editingIndex !== null) {
                const updatedItems = [...(window.currentItinerary || [])];
                
                // 建立客製化確認視窗
                const confirmMessage = `確定要刪除活動：${updatedItems[editingIndex].activity} 嗎？`;
                const confirmation = await showCustomConfirm(confirmMessage);

                if (confirmation) {
                    updatedItems.splice(editingIndex, 1);
                    await saveItinerary(window.selectedDate, updatedItems);
                    window.closeModal();
                }
            }
        });

        // --- 日期選擇邏輯 ---

        // 已更新日期：1/4 到 1/11 (共 8 天)
        const dates = ["01/04", "01/05", "01/06", "01/07", "01/08", "01/09", "01/10", "01/11"];
        window.selectedDate = dates[0]; // 預設選中 1/4

        /**
         * 選擇日期並載入行程
         * @param {string} date - 選中的日期
         */
        window.selectDate = (date) => {
            // 清除前一個日期的監聽器
            if (window.itineraryUnsubscribe) {
                window.itineraryUnsubscribe();
            }

            window.selectedDate = date;
            
            // 更新 UI 上的選中狀態
            document.querySelectorAll('.date-btn').forEach(btn => {
                // 取消選中：使用 amber-400 文字色
                btn.classList.remove('bg-amber-600', 'text-white');
                btn.classList.add('bg-gray-900', 'text-amber-400', 'hover:bg-gray-800');
            });
            // 選中：使用 amber-600 背景
            document.getElementById(`date-${date.replace('/', '-')}`).classList.remove('bg-gray-900', 'text-amber-400', 'hover:bg-gray-800');
            document.getElementById(`date-${date.replace('/', '-')}`).classList.add('bg-amber-600', 'text-white', 'shadow-lg');

            // 更新主標題
            document.getElementById('current-date-title').textContent = `${date} 行程`;

            // 載入新日期的行程
            if (isAuthReady) {
                loadItinerary(date);
            }
        };

        // 初始化日期按鈕和選中第一個日期
        document.addEventListener('DOMContentLoaded', () => {
            const dateNav = document.getElementById('date-nav');
            dates.forEach(date => {
                const btn = document.createElement('button');
                btn.id = `date-${date.replace('/', '-')}`;
                // 調整日期按鈕的深色背景
                btn.className = `date-btn px-4 py-2 rounded-full font-semibold transition duration-150 ease-in-out whitespace-nowrap`;
                // 顯示格式：[月]/[日]
                btn.innerHTML = `<span class="block text-xs opacity-75">${date.split('/')[0]}月</span><span class="block text-xl">${date.split('/')[1]}日</span>`;
                btn.onclick = () => window.selectDate(date);
                dateNav.appendChild(btn);
            });
            
            window.selectDate(window.selectedDate); // 選擇初始日期
            initFirebase();
            initializeInitialData(); // 創建初始數據
        });

        /**
         * 初始化範例數據（僅在文件不存在時寫入）
         */
        const initializeInitialData = async () => {
            if (!isAuthReady || !userId) {
                // 等待認證完成再嘗試
                setTimeout(initializeInitialData, 500);
                return;
            }

            const path = getItineraryCollectionPath();
            if (!path) return;

            // 範例行程數據 (冬季 1 月)
            const initialData = {
                "01/04": [
                    { time: "14:00", activity: "抵達新千歲機場 (CTS)", location: "新千歲機場", details: "辦理入境手續。\n搭乘 JR 快速 Airport 線至札幌。", id: crypto.randomUUID() },
                    { time: "17:00", activity: "札幌市區 Check-in", location: "JR 札幌站", details: "放下行李，準備外出用餐。", id: crypto.randomUUID() },
                    { time: "19:30", activity: "晚餐：札幌拉麵橫丁", location: "拉麵橫丁", details: "品嚐味噌拉麵，感受札幌冬夜的溫暖。", id: crypto.randomUUID() }
                ],
                "01/05": [
                    { time: "10:00", activity: "前往小樽運河", location: "小樽運河", details: "從札幌搭乘 JR 約 40 分鐘。冬季運河旁有積雪。", id: crypto.randomUUID() },
                    { time: "12:30", activity: "午餐：小樽壽司街", location: "小樽壽司通", details: "選擇一家老字號壽司店。", id: crypto.randomUUID() },
                    { time: "15:00", activity: "北一硝子館與八音盒館", location: "北一硝子", details: "參觀玻璃工藝品和充滿懷舊氣息的音樂盒。", id: crypto.randomUUID() },
                    { time: "18:00", activity: "返回札幌", location: "札幌站", details: "在站前大丸百貨逛逛。", id: crypto.randomUUID() }
                ],
                "01/06": [
                    { time: "10:30", activity: "札幌地標巡禮", location: "札幌時計台", details: "在雪景中拍照留念。", id: crypto.randomUUID() },
                    { time: "12:30", activity: "午餐：二條市場", location: "二條市場", details: "享用新鮮海鮮蓋飯。", id: crypto.randomUUID() },
                    { time: "15:00", activity: "大通公園與電視塔", location: "大通公園", details: "為即將到來的札幌雪祭勘景。", id: crypto.randomUUID() },
                    { time: "19:00", activity: "晚餐：成吉思汗烤羊肉", location: "薄野", details: "品嚐北海道的特色烤羊肉 (Genghis Khan BBQ)。", id: crypto.randomUUID() }
                ]
                // 1/7 到 1/11 預設為空
            };

            for (const date of dates) {
                // 使用連字符替換斜線，以避免 Firestore 將其誤認為路徑分隔符。
                const docId = date.replace('/', '-'); 
                const docRef = doc(db, path, docId);
                try {
                    const docSnap = await getDoc(docRef);
                    if (!docSnap.exists()) {
                        console.log(`Setting initial data for ${date}.`);
                        await setDoc(docRef, { 
                            items: initialData[date] || [] 
                        });
                    }
                } catch (error) {
                    console.error(`Error initializing initial data for ${date}:`, error);
                }
            }
        };

        // --- 客製化確認彈窗邏輯 ---
        const customConfirmModal = document.getElementById('custom-confirm-modal');
        const confirmMessageEl = document.getElementById('confirm-message');
        const confirmYesBtn = document.getElementById('confirm-yes');
        const confirmNoBtn = document.getElementById('confirm-no');
        let resolveConfirmPromise;

        /**
         * 顯示客製化確認彈窗
         * @param {string} message - 確認訊息
         * @returns {Promise<boolean>} - 返回 true/false
         */
        const showCustomConfirm = (message) => {
            confirmMessageEl.textContent = message;
            customConfirmModal.classList.remove('hidden');

            return new Promise((resolve) => {
                resolveConfirmPromise = resolve;
            });
        };

        confirmYesBtn.addEventListener('click', () => {
            customConfirmModal.classList.add('hidden');
            if (resolveConfirmPromise) resolveConfirmPromise(true);
        });

        confirmNoBtn.addEventListener('click', () => {
            customConfirmModal.classList.add('hidden');
            if (resolveConfirmPromise) resolveConfirmPromise(false);
        });

    </script>

    <style>
        /* 使用 Inter 字體 */
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s;
        }
        /* 隱藏滾動條，保持頁面乾淨 */
        ::-webkit-scrollbar {
            display: none;
        }
        .itinerary-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem; /* 增加間距 */
            position: relative;
            padding-left: 20px; /* 增加左側內邊距 */
        }
        /* 時間軸線條 (使用更深的灰色) */
        .itinerary-grid::before {
            content: '';
            position: absolute;
            top: 0;
            left: 20px; /* 線條位置 */
            width: 2px;
            background-color: #1f2937; /* gray-800 */
            z-index: 0;
            height: 100%; /* 確保線條高度為 100% */
        }
        .itinerary-grid > div {
            position: relative;
            margin-left: 20px; /* 調整卡片位置以避開線條 */
            padding-left: 20px; /* 為卡片內容增加左側內邊距 */
        }
        /* 裝飾圓點 (邊框使用接近純黑的顏色) */
        .itinerary-grid > div::before {
            content: '';
            position: absolute;
            left: -12px; /* 圓點位置 */
            top: 1.5rem;
            width: 12px;
            height: 12px;
            /* 將點的顏色從 teal 替換為 amber (f59e0b) */
            background-color: #f59e0b; 
            border-radius: 50%;
            border: 4px solid #030712; /* gray-950 (接近純黑) */
            z-index: 10;
        }

        /* 響應式日期導航 */
        #date-nav {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* Markdown 內容樣式 */
        .markdown-body h1, .markdown-body h2, .markdown-body h3 {
            color: #fbbf24; /* amber-400 */
            font-weight: bold;
            margin-top: 1em;
            margin-bottom: 0.5em;
        }
        .markdown-body p {
            margin-bottom: 0.8em;
            line-height: 1.6;
        }
        .markdown-body ul, .markdown-body ol {
            padding-left: 1.5em;
            margin-bottom: 0.8em;
        }
        .markdown-body li {
            list-style-type: disc;
        }
        .markdown-body strong {
            color: #f59e0b; /* amber-500 */
        }
    </style>
</head>
<!-- 主背景調整為 bg-gray-950 (極深黑), 移除預設 padding，改在內部 wrapper 處理 -->
<body class="bg-gray-950 text-white min-h-screen">

    <!-- 主容器 -->
    <div class="max-w-4xl mx-auto">
        
        <!-- Sticky Header Container (固定頂部區域) -->
        <div class="sticky top-0 z-50 bg-gray-950 pt-4 sm:pt-8 px-4 sm:px-8 pb-2 shadow-lg border-b border-gray-800/50">
            <!-- 標題 -->
            <header class="mb-4">
                <h1 class="text-3xl sm:text-4xl font-extrabold tracking-tight text-amber-400">2026北海道之旅</h1>
                <p class="text-sm text-gray-400 mt-1" id="user-id-display">使用者 ID: 載入中...</p>
            </header>

            <!-- 日期導航 -->
            <nav id="date-nav" class="flex space-x-3 p-2 bg-gray-900 rounded-xl shadow-inner">
                <!-- 日期按鈕將由 JavaScript 填充 -->
            </nav>
        </div>

        <!-- 內容容器 (Padding moved here) -->
        <div class="p-4 sm:p-8 pt-6">
            
            <!-- Google Maps 按鈕 -->
            <div class="mb-4">
                <button id="google-map-btn" onclick="openGoogleMapsRoute()" class="w-full bg-gray-900 hover:bg-gray-800 border border-amber-600 text-amber-500 hover:text-amber-400 font-bold py-4 px-4 rounded-xl shadow-lg transition duration-300 flex items-center justify-center">
                    <span class="material-icons mr-2">map</span>
                    在 Google 地圖查看路線
                </button>
            </div>

            <!-- AI 功能區 -->
            <div class="mb-8 grid grid-cols-2 gap-3">
                <button onclick="auditItinerary()" class="bg-gray-900 hover:bg-gray-800 border border-gray-700 hover:border-amber-500/50 text-gray-300 hover:text-amber-400 font-bold py-3 px-4 rounded-xl shadow-lg transition duration-300 flex items-center justify-center">
                    <span class="material-icons mr-2 text-amber-500">check_circle</span>
                    AI 行程健檢
                </button>
                <button onclick="recommendNearby()" class="bg-gray-900 hover:bg-gray-800 border border-gray-700 hover:border-amber-500/50 text-gray-300 hover:text-amber-400 font-bold py-3 px-4 rounded-xl shadow-lg transition duration-300 flex items-center justify-center">
                    <span class="material-icons mr-2 text-amber-500">explore</span>
                    推薦周邊美食
                </button>
            </div>

            <!-- 行程內容區 -->
            <main class="mb-24">
                <h2 id="current-date-title" class="text-2xl font-bold text-white mb-6">01/04 行程</h2>
                <div id="itinerary-list" class="itinerary-grid">
                    <!-- 行程卡片將由 JavaScript 填充 -->
                    <div class="text-gray-500 p-4">載入中...</div>
                </div>
            </main>

            <!-- 狀態訊息 -->
            <div id="status-message" class="fixed bottom-2 left-1/2 transform -translate-x-1/2 bg-yellow-600 text-white text-sm px-4 py-2 rounded-lg shadow-xl hidden"></div>

            <!-- 右下角浮動加號按鈕 (FAB) -->
            <button id="add-fab" onclick="openAddModal()"
                class="fixed bottom-8 right-8 bg-amber-500 hover:bg-amber-600 text-white w-14 h-14 flex items-center justify-center rounded-2xl shadow-2xl transition duration-300 ease-in-out transform hover:scale-110 focus:outline-none focus:ring-4 focus:ring-amber-500 focus:ring-opacity-50 z-40">
                <span class="material-icons text-3xl">add</span>
            </button>
        </div>
    </div>

    <!-- AI 回應模態框 (Modal) -->
    <div id="ai-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-900 rounded-xl shadow-2xl w-11/12 max-w-2xl p-6 relative flex flex-col max-h-[85vh]">
            <div class="flex justify-between items-center mb-4 border-b border-gray-800 pb-2">
                <h3 class="text-2xl font-bold text-amber-400 flex items-center">
                    <span class="material-icons mr-2">smart_toy</span> AI 旅遊顧問
                </h3>
                <button onclick="closeAIModal()" class="text-gray-500 hover:text-white transition-colors">
                    <span class="material-icons">close</span>
                </button>
            </div>
            
            <div class="overflow-y-auto flex-grow pr-2 custom-scrollbar">
                <!-- AI Loading -->
                <div id="ai-loading" class="flex flex-col items-center justify-center py-12">
                    <div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-amber-500 mb-4"></div>
                    <p class="text-gray-400 animate-pulse">AI 正在思考中...</p>
                </div>
                
                <!-- AI Content -->
                <div id="ai-content" class="markdown-body text-gray-300 text-sm sm:text-base leading-relaxed">
                    <!-- 內容將由 JS 填充 -->
                </div>
            </div>

            <div class="mt-4 pt-2 border-t border-gray-800 text-center">
                <button onclick="closeAIModal()" class="w-full py-2 bg-gray-800 hover:bg-gray-700 text-white rounded-lg transition-colors">
                    關閉
                </button>
            </div>
        </div>
    </div>

    <!-- 行程新增/編輯模態框 (Modal) -->
    <div id="itinerary-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-900 rounded-xl shadow-2xl w-11/12 max-w-lg p-6 relative">
            <h3 id="modal-title" class="text-2xl font-bold mb-4 text-amber-400">新增行程項目</h3>
            
            <form id="itinerary-form">
                
                <!-- 時間 (Time) -->
                <div class="mb-4">
                    <label for="time" class="block text-sm font-medium text-gray-300 mb-1">時間 (HH:MM)</label>
                    <input type="time" id="time" class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white focus:ring-amber-500 focus:border-amber-500">
                </div>
                
                <!-- 活動 (Activity) -->
                <div class="mb-4">
                    <label for="activity" class="block text-sm font-medium text-gray-300 mb-1">活動名稱 *</label>
                    <input type="text" id="activity" required class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white focus:ring-amber-500 focus:border-amber-500">
                </div>
                
                <!-- 地點 (Location) -->
                <div class="mb-4">
                    <label for="location" class="block text-sm font-medium text-gray-300 mb-1">地點</label>
                    <input type="text" id="location" placeholder="例如：札幌電視塔" class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white focus:ring-amber-500 focus:border-amber-500">
                </div>
                
                <!-- 詳細說明 (Details) -->
                <div class="mb-6">
                    <label for="details" class="block text-sm font-medium text-gray-300 mb-1">詳細說明</label>
                    <textarea id="details" rows="3" class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white focus:ring-amber-500 focus:border-amber-500"></textarea>
                </div>

                <div class="flex flex-col sm:flex-row justify-between space-y-3 sm:space-y-0 sm:space-x-3">
                    <button type="button" id="delete-btn" class="hidden w-full sm:w-auto px-4 py-3 text-sm font-semibold rounded-lg bg-red-600 hover:bg-red-700 transition duration-150 text-white" >
                        刪除
                    </button>
                    <div class="flex space-x-3 w-full sm:w-auto">
                        <button type="button" onclick="closeModal()" class="w-full px-4 py-3 text-sm font-semibold rounded-lg bg-gray-700 hover:bg-gray-600 transition duration-150 text-white">
                            取消
                        </button>
                        <button type="submit" class="w-full px-4 py-3 text-sm font-semibold rounded-lg bg-amber-500 hover:bg-amber-600 transition duration-150 text-white">
                            儲存
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- 客製化確認彈窗 -->
    <div id="custom-confirm-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[60] hidden">
        <div class="bg-gray-900 rounded-xl shadow-2xl w-11/12 max-w-sm p-6">
            <h4 class="text-xl font-bold mb-4 text-red-400">確認操作</h4>
            <p id="confirm-message" class="text-gray-300 mb-6">確定要執行此操作嗎？</p>
            <div class="flex justify-end space-x-3">
                <button id="confirm-no" class="px-4 py-2 text-sm font-semibold rounded-lg bg-gray-700 hover:bg-gray-600 transition duration-150 text-white">
                    取消
                </button>
                <button id="confirm-yes" class="px-4 py-2 text-sm font-semibold rounded-lg bg-red-600 hover:bg-red-700 transition duration-150 text-white">
                    確認刪除
                </button>
            </div>
        </div>
    </div>

</body>
</html>
