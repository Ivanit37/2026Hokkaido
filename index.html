<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026åŒ—æµ·é“è¡Œç¨‹è¦åŠƒå™¨</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Font Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <!-- å¼•å…¥ Google Material Icons (ç”¨æ–¼åŠ è™Ÿ FAB) -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot, getDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // è¨­å®š Firebase Debug Log
        setLogLevel('silent'); 

        // å…¨åŸŸè®Šæ•¸ - å„ªå…ˆä½¿ç”¨ç’°å¢ƒè®Šæ•¸ï¼Œè‹¥ç„¡å‰‡ä½¿ç”¨é è¨­å€¼
        const appId = typeof __app_id !== 'undefined' ? __app_id : '2026hokkaido';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; 
        
        // --- âš ï¸ é‡è¦ï¼šè«‹å¡«å…¥æ‚¨çš„ Firebase è¨­å®š ---
        const firebaseConfig = {
            apiKey: "AIzaSyBsHR53LDslQL5D9_l79wJA7NUOe8mrCe8",
            authDomain: "hokkaido-fc132.firebaseapp.com",
            projectId: "hokkaido-fc132",
            storageBucket: "hokkaido-fc132.firebasestorage.app",
            messagingSenderId: "107783904784",
            appId: "1:107783904784:web:3635a0aca3fd8478a03495",
        };
        
        let app, db, auth;
        let userId = null;
        let isAuthReady = false;
        
        // åˆå§‹åŒ– Firebase
        if (Object.keys(firebaseConfig).length > 0) {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
            } catch (e) {
                console.error("Firebase Initialization Error:", e);
                showStatusMessage("Firebase åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Config", true);
            }
        } else {
            console.error("Firebase Configuration is missing.");
        }

        /**
         * é¡¯ç¤ºç‹€æ…‹è¨Šæ¯çš„è¼”åŠ©å‡½å¼
         */
        const showStatusMessage = (htmlContent, isError = false) => {
            const statusMsg = document.getElementById('status-message');
            if (statusMsg) {
                statusMsg.innerHTML = htmlContent;
                statusMsg.classList.remove('hidden');
                if (isError) {
                    statusMsg.className = "fixed bottom-2 left-1/2 transform -translate-x-1/2 bg-red-600 text-white text-sm px-6 py-4 rounded-lg shadow-xl z-40 max-w-md text-center";
                } else {
                    statusMsg.className = "fixed bottom-2 left-1/2 transform -translate-x-1/2 bg-yellow-600 text-white text-sm px-4 py-2 rounded-lg shadow-xl z-40";
                }
            }
        };

        /**
         * é¡¯ç¤ºæ¬Šé™éŒ¯èª¤æ•™å­¸æ¨¡æ…‹æ¡†
         */
        const showPermissionErrorModal = () => {
            const modal = document.getElementById('permission-modal');
            modal.classList.remove('hidden');
        };

        /**
         * è™•ç† Firebase èªè­‰å’Œåˆå§‹åŒ–
         */
        const initFirebase = async () => {
            if (!app || !db || !auth) {
                console.error("Firebase services are not available.");
                return;
            }

            try {
                // å˜—è©¦ä½¿ç”¨ç’°å¢ƒæä¾›çš„ Custom Token ç™»å…¥
                if (initialAuthToken) {
                    try {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Signed in with custom token");
                    } catch (tokenError) {
                        // å¦‚æœ Token é©—è­‰å¤±æ•— (ä¾‹å¦‚ï¼šå°ˆæ¡ˆä¸åŒ¹é…)ï¼Œå‰‡è‡ªå‹•é™ç´šç‚ºåŒ¿åç™»å…¥
                        console.warn("Custom token mismatch or invalid, falling back to anonymous auth...", tokenError);
                        await signInAnonymously(auth);
                        console.log("Signed in anonymously (fallback)");
                    }
                } else {
                    // è‹¥ç„¡ Tokenï¼Œç›´æ¥åŒ¿åç™»å…¥
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously");
                }
            } catch (error) {
                console.error("Firebase Authentication failed:", error);
                
                let errorMsg = `èªè­‰å¤±æ•— (${error.code}): ${error.message}`;
                
                if (error.code === 'auth/configuration-not-found' || error.code === 'auth/operation-not-allowed') {
                     errorMsg = `
                        <strong>âš ï¸ èªè­‰è¨­å®šæœªå•Ÿç”¨</strong><br/>
                        è«‹å‰å¾€ Firebase Console > Build > Authentication > Sign-in method<br/>
                        ä¸¦å•Ÿç”¨ <b>Anonymous (åŒ¿å)</b> ç™»å…¥é¸é …ã€‚
                     `;
                } else if (error.code === 'auth/api-key-not-valid-please-pass-a-valid-api-key') {
                    errorMsg = `<strong>âš ï¸ API Key ç„¡æ•ˆ</strong><br/>è«‹æª¢æŸ¥ firebaseConfig ä¸­çš„ apiKey æ˜¯å¦æ­£ç¢ºã€‚`;
                }
                
                showStatusMessage(errorMsg, true);
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    // åˆå§‹åŒ–æ™‚è¼‰å…¥ç¬¬ä¸€å€‹æ—¥æœŸ
                    loadItinerary(window.selectedDate);
                    console.log(`User authenticated. UID: ${userId}`);
                    // é¡¯ç¤ºç”¨æˆ¶ID
                    document.getElementById('user-id-display').textContent = `ä½¿ç”¨è€… ID: ${userId}`;
                    
                    // èªè­‰æˆåŠŸï¼Œè‹¥ä¹‹å‰æœ‰é¡¯ç¤ºèªè­‰å¤±æ•—è¨Šæ¯å‰‡éš±è—
                    const statusMsg = document.getElementById('status-message');
                    if (statusMsg && statusMsg.textContent.includes('èªè­‰å¤±æ•—')) {
                        statusMsg.classList.add('hidden');
                    }

                    // èªè­‰æˆåŠŸå¾Œæ‰é–‹å§‹åˆå§‹åŒ–è³‡æ–™
                    initializeInitialData();

                } else {
                    userId = null;
                    isAuthReady = true;
                    console.log("User signed out or anonymous.");
                }
            });
        };

        // å°èˆªåˆ°ç”¨æˆ¶æ•¸æ“šçš„é›†åˆè·¯å¾‘
        const getItineraryCollectionPath = () => {
            if (!userId) return null;
            // ç§äººæ•¸æ“šè·¯å¾‘ï¼š /artifacts/{appId}/users/{userId}/hokkaido_itinerary
            return `artifacts/${appId}/users/${userId}/hokkaido_itinerary`;
        };

        // --- åœ°åœ–é€£çµåŠŸèƒ½ ---

        window.openGoogleMapsRoute = () => {
            const items = window.currentItinerary || [];
            const locations = items
                .filter(item => item.location && item.location.trim() !== "")
                .sort((a, b) => (a.time || '').localeCompare(b.time || ''))
                .map(item => item.location.trim());

            if (locations.length === 0) { alert("ç›®å‰è¡Œç¨‹ä¸­æ²’æœ‰ä»»ä½•åœ°é»è³‡è¨Šï¼Œç„¡æ³•å»ºç«‹è·¯ç·šã€‚"); return; }

            let url = "";
            if (locations.length === 1) {
                const query = encodeURIComponent(locations[0]);
                url = `https://www.google.com/maps/search/?api=1&query=${query}`;
            } else {
                const origin = encodeURIComponent(locations[0]);
                const destination = encodeURIComponent(locations[locations.length - 1]);
                let waypoints = "";
                if (locations.length > 2) {
                    const waypointList = locations.slice(1, locations.length - 1).map(loc => encodeURIComponent(loc));
                    waypoints = `&waypoints=${waypointList.join('|')}`;
                }
                url = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}${waypoints}`;
            }
            window.open(url, '_blank');
        };

        // æ–°å¢æœå°‹åœ°é»åŠŸèƒ½ (ä¸ä½¿ç”¨ APIï¼Œç›´æ¥è·³è½‰)
        window.searchLocationOnMap = () => {
            const locationVal = document.getElementById('location').value.trim();
            if (locationVal) {
                window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(locationVal)}`, '_blank');
            } else {
                alert("è«‹å…ˆè¼¸å…¥åœ°é»é—œéµå­—ï¼Œä¾‹å¦‚ã€Œæœ­å¹Œæ‹‰éºµã€ï¼Œå†é»æ“Šæœå°‹æŒ‰éˆ•ç¢ºèªç¢ºåˆ‡åº—åã€‚");
            }
        };

        // --- èˆªç­è³‡è¨Šé‚è¼¯ ---
        
        /**
         * æ›´æ–°èˆªç­è³‡è¨Šé¡¯ç¤º
         * @param {string} date - ç•¶å‰é¸æ“‡çš„æ—¥æœŸ MM/DD
         */
        const updateFlightInfo = (date) => {
            const flightCard = document.getElementById('flight-info-card');
            
            // é è¨­éš±è—
            flightCard.classList.add('hidden');
            
            if (date === '01/04') {
                // å»ç¨‹èˆªç­
                renderFlightCard({
                    flightNo: 'HB008',
                    airline: 'å¤§ç£å€èˆªç©º (GBA)',
                    depCity: 'é¦™æ¸¯ (HKG)',
                    arrCity: 'æœ­å¹Œ (CTS)',
                    // å‡è¨­æ™‚é–“ï¼Œå¯¦éš›è«‹ä¾æ“šæ‚¨çš„æ©Ÿç¥¨èª¿æ•´
                    depTime: '08:55', 
                    arrTime: '14:50',
                    link: 'https://www.flightradar24.com/data/flights/hb8'
                });
                flightCard.classList.remove('hidden');
            } else if (date === '01/11') {
                // å›ç¨‹èˆªç­
                renderFlightCard({
                    flightNo: 'HB009',
                    airline: 'å¤§ç£å€èˆªç©º (GBA)',
                    depCity: 'æœ­å¹Œ (CTS)',
                    arrCity: 'é¦™æ¸¯ (HKG)',
                    // å‡è¨­æ™‚é–“
                    depTime: '15:50', 
                    arrTime: '21:00',
                    link: 'https://www.flightradar24.com/data/flights/hb9'
                });
                flightCard.classList.remove('hidden');
            }
        };

        const renderFlightCard = (data) => {
            const container = document.getElementById('flight-info-card');
            container.innerHTML = `
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center space-x-2">
                        <span class="material-icons text-blue-400 rotate-90">flight</span>
                        <span class="font-bold text-lg text-white">${data.flightNo}</span>
                    </div>
                    <span class="text-xs bg-blue-900 text-blue-200 px-2 py-1 rounded border border-blue-700">${data.airline}</span>
                </div>
                
                <div class="flex justify-between items-center text-center mb-4">
                    <div class="flex-1">
                        <div class="text-2xl font-bold text-white">${data.depTime}</div>
                        <div class="text-sm text-gray-400 font-bold mt-1">${data.depCity}</div>
                    </div>
                    
                    <div class="flex-1 flex flex-col items-center px-2">
                        <div class="text-xs text-gray-500 mb-1">ç›´é£›</div>
                        <div class="w-full h-0.5 bg-gray-600 relative">
                            <div class="absolute -right-1 -top-1 w-2 h-2 bg-gray-600 rounded-full"></div>
                        </div>
                    </div>
                    
                    <div class="flex-1">
                        <div class="text-2xl font-bold text-white">${data.arrTime}</div>
                        <div class="text-sm text-gray-400 font-bold mt-1">${data.arrCity}</div>
                    </div>
                </div>

                <a href="${data.link}" target="_blank" class="block w-full text-center bg-gray-800 hover:bg-gray-700 text-blue-400 text-sm py-2 rounded-lg transition-colors border border-gray-700 hover:border-blue-500/50">
                    <span class="flex items-center justify-center">
                        <span class="material-icons text-sm mr-1">radar</span>
                        æŸ¥çœ‹ FlightRadar24 å³æ™‚å‹•æ…‹
                    </span>
                </a>
            `;
        };

        // --- Firestore é‚è¼¯ ---

        const loadItinerary = (date) => {
            const itineraryContainer = document.getElementById('itinerary-list');
            itineraryContainer.innerHTML = '<div class="text-gray-500 p-4">è¼‰å…¥ä¸­...</div>';

            if (!isAuthReady || !userId) return;

            const path = getItineraryCollectionPath();
            if (!path) return;

            const docId = date.replace('/', '-'); 
            const docRef = doc(db, path, docId);
            
            window.itineraryUnsubscribe = onSnapshot(docRef, (docSnap) => {
                const itineraryList = docSnap.exists() ? docSnap.data().items : [];
                window.currentItinerary = itineraryList;
                renderItinerary(itineraryList);
                updateMapButtonState(itineraryList);
            }, (error) => {
                console.error("Error fetching itinerary:", error);
                
                if (error.code === 'permission-denied') {
                    showPermissionErrorModal();
                } else if (error.message.includes('offline')) {
                    showStatusMessage(`<strong>âš ï¸ ç„¡æ³•é€£æ¥è³‡æ–™åº«</strong><br/>è«‹å‰å¾€ Firebase Console å»ºç«‹ <strong>Cloud Firestore</strong> è³‡æ–™åº«ã€‚`, true);
                }
                
                itineraryContainer.innerHTML = `<div class="text-red-400 p-4">è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥è³‡æ–™åº«é€£ç·šæˆ–æ¬Šé™ã€‚</div>`;
            });
        };

        const updateMapButtonState = (items) => {
            const btn = document.getElementById('google-map-btn');
            const hasLocations = items.some(item => item.location && item.location.trim() !== "");
            if (hasLocations) {
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
                btn.disabled = false;
                btn.innerHTML = `<span class="material-icons mr-2">map</span>åœ¨ Google åœ°åœ–æŸ¥çœ‹è·¯ç·š`;
            } else {
                btn.classList.add('opacity-50', 'cursor-not-allowed');
                btn.disabled = true;
                btn.innerHTML = `<span class="material-icons mr-2">map</span>ç„¡åœ°é»è³‡è¨Š`;
            }
        };

        const renderItinerary = (items) => {
            const itineraryContainer = document.getElementById('itinerary-list');
            itineraryContainer.innerHTML = '';

            if (items.length === 0) {
                itineraryContainer.innerHTML = `
                    <div class="text-center p-8 bg-gray-900 rounded-xl">
                        <p class="text-lg text-gray-400 mb-2">æœ¬æ—¥è¡Œç¨‹å°šæœªå®‰æ’</p>
                        <p class="text-sm text-gray-500">é»æ“Šå³ä¸‹è§’ '+' æ–°å¢æ´»å‹•</p>
                    </div>
                `;
                return;
            }

            items.sort((a, b) => (a.time || '').localeCompare(b.time || ''));

            items.forEach((item, index) => {
                const card = document.createElement('div');
                card.className = 'bg-gray-900 p-4 rounded-xl shadow-lg border-l-4 border-amber-500 hover:bg-gray-800 transition duration-150 ease-in-out cursor-pointer group';
                
                const locationDisplay = item.location ? 
                    `<p class="text-sm text-gray-400 italic mt-1 flex items-center">${item.location}</p>` : 
                    `<p class="text-sm text-gray-500 italic mt-1">ç„¡åœ°é»</p>`;

                const mapBtnHtml = item.location ? `
                    <button class="map-item-btn text-gray-500 hover:text-amber-400 p-2 rounded-full transition-colors" title="åœ¨ Google åœ°åœ–ä¸­æŸ¥çœ‹">
                        <span class="material-icons text-lg">place</span>
                    </button>
                ` : '';

                const editBtnHtml = `
                    <button class="edit-btn text-gray-500 hover:text-amber-400 p-2 rounded-full transition-colors" data-index="${index}" title="ç·¨è¼¯å…§å®¹">
                        <span class="material-icons text-lg">edit</span>
                    </button>
                `;

                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-grow pr-2">
                            <p class="text-xs font-mono text-amber-400 mb-1">${item.time || 'N/A'}</p>
                            <h3 class="text-xl font-bold text-white mt-1 flex items-center">${item.activity || 'ç„¡æ¨™é¡Œæ´»å‹•'}</h3>
                            ${locationDisplay}
                            <p class="text-sm text-gray-300 mt-2 whitespace-pre-wrap">${item.details || 'ç„¡è©³ç´°èªªæ˜'}</p>
                        </div>
                        <div class="flex items-center space-x-1 opacity-100 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity shrink-0">
                            ${mapBtnHtml}
                            ${editBtnHtml}
                        </div>
                    </div>
                `;
                
                card.addEventListener('click', () => { openEditModal(index); });
                const editBtn = card.querySelector('.edit-btn');
                if (editBtn) { editBtn.addEventListener('click', (e) => { e.stopPropagation(); openEditModal(index); }); }
                const mapBtn = card.querySelector('.map-item-btn');
                if (mapBtn) { mapBtn.addEventListener('click', (e) => { e.stopPropagation(); const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.location)}`; window.open(url, '_blank'); }); }

                itineraryContainer.appendChild(card);
            });
        };

        const saveItinerary = async (date, items) => {
            if (!isAuthReady || !userId) { showStatusMessage('éŒ¯èª¤ï¼šå°šæœªå®Œæˆèªè­‰ã€‚', true); return; }

            const path = getItineraryCollectionPath();
            if (!path) return;

            const docId = date.replace('/', '-'); 
            const docRef = doc(db, path, docId);
            try {
                await setDoc(docRef, { items: items }, { merge: true });
            } catch (error) {
                console.error("Error saving itinerary:", error);
                if (error.code === 'permission-denied') {
                    showPermissionErrorModal();
                } else {
                    showStatusMessage(`å„²å­˜å¤±æ•—: ${error.message}`, true);
                }
            }
        };

        // --- æ¨¡æ…‹æ¡† (Modal) é‚è¼¯ ---

        const modal = document.getElementById('itinerary-modal');
        const modalForm = document.getElementById('itinerary-form');
        const modalTitle = document.getElementById('modal-title');
        let editingIndex = null; 

        window.openAddModal = () => {
            editingIndex = null;
            modalTitle.textContent = 'æ–°å¢è¡Œç¨‹é …ç›®';
            modalForm.reset();
            modal.classList.remove('hidden');
        };

        const openEditModal = (index) => {
            editingIndex = index;
            modalTitle.textContent = 'ç·¨è¼¯è¡Œç¨‹é …ç›®';
            const item = window.currentItinerary[index];
            document.getElementById('time').value = item.time || '';
            document.getElementById('activity').value = item.activity || '';
            document.getElementById('location').value = item.location || '';
            document.getElementById('details').value = item.details || '';
            document.getElementById('delete-btn').classList.remove('hidden');
            modal.classList.remove('hidden');
        };

        window.closeModal = () => {
            modal.classList.add('hidden');
            document.getElementById('delete-btn').classList.add('hidden');
            modalForm.reset();
        };

        modalForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const time = document.getElementById('time').value.trim();
            const activity = document.getElementById('activity').value.trim();
            const location = document.getElementById('location').value.trim();
            const details = document.getElementById('details').value.trim();
            
            if (!activity) { showStatusMessage('æ´»å‹•åç¨±ä¸èƒ½ç‚ºç©ºã€‚', true); return; }
            
            const newItem = { 
                time, activity, location, details, 
                id: editingIndex !== null ? window.currentItinerary[editingIndex].id : crypto.randomUUID() 
            };
            
            let updatedItems = [...(window.currentItinerary || [])];
            if (editingIndex !== null) { updatedItems[editingIndex] = newItem; } else { updatedItems.push(newItem); }

            await saveItinerary(window.selectedDate, updatedItems);
            window.closeModal();
        });

        document.getElementById('delete-btn').addEventListener('click', async () => {
            if (editingIndex !== null) {
                const updatedItems = [...(window.currentItinerary || [])];
                const confirmMessage = `ç¢ºå®šè¦åˆªé™¤æ´»å‹•ï¼š${updatedItems[editingIndex].activity} å—ï¼Ÿ`;
                const confirmation = await showCustomConfirm(confirmMessage);
                if (confirmation) {
                    updatedItems.splice(editingIndex, 1);
                    await saveItinerary(window.selectedDate, updatedItems);
                    window.closeModal();
                }
            }
        });

        // è¤‡è£½è¦å‰‡
        window.copyRules = () => {
            const rulesText = document.getElementById('rules-code').innerText;
            navigator.clipboard.writeText(rulesText).then(() => {
                const btn = document.getElementById('copy-rules-btn');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<span class="material-icons text-sm mr-1">check</span>å·²è¤‡è£½';
                btn.classList.replace('bg-blue-600', 'bg-green-600');
                btn.classList.replace('hover:bg-blue-700', 'hover:bg-green-700');
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.replace('bg-green-600', 'bg-blue-600');
                    btn.classList.replace('hover:bg-green-700', 'hover:bg-blue-700');
                }, 2000);
            });
        };
        
        window.closePermissionModal = () => {
             document.getElementById('permission-modal').classList.add('hidden');
        };

        // --- æ—¥æœŸé¸æ“‡é‚è¼¯ ---

        const dates = ["01/04", "01/05", "01/06", "01/07", "01/08", "01/09", "01/10", "01/11"];
        window.selectedDate = dates[0]; 

        window.selectDate = (date) => {
            if (window.itineraryUnsubscribe) { window.itineraryUnsubscribe(); }
            window.selectedDate = date;
            
            document.querySelectorAll('.date-btn').forEach(btn => {
                btn.classList.remove('bg-amber-600', 'text-white');
                btn.classList.add('bg-gray-900', 'text-amber-400', 'hover:bg-gray-800');
            });
            document.getElementById(`date-${date.replace('/', '-')}`).classList.remove('bg-gray-900', 'text-amber-400', 'hover:bg-gray-800');
            document.getElementById(`date-${date.replace('/', '-')}`).classList.add('bg-amber-600', 'text-white', 'shadow-lg');

            document.getElementById('current-date-title').textContent = `${date} è¡Œç¨‹`;
            
            // æ›´æ–°èˆªç­è³‡è¨Š (æ–°å¢çš„é‚è¼¯)
            updateFlightInfo(date);

            if (isAuthReady) { loadItinerary(date); }
        };

        document.addEventListener('DOMContentLoaded', () => {
            const dateNav = document.getElementById('date-nav');
            dates.forEach(date => {
                const btn = document.createElement('button');
                btn.id = `date-${date.replace('/', '-')}`;
                btn.className = `date-btn px-4 py-2 rounded-full font-semibold transition duration-150 ease-in-out whitespace-nowrap`;
                btn.innerHTML = `<span class="block text-xs opacity-75">${date.split('/')[0]}æœˆ</span><span class="block text-xl">${date.split('/')[1]}æ—¥</span>`;
                btn.onclick = () => window.selectDate(date);
                dateNav.appendChild(btn);
            });
            window.selectDate(window.selectedDate); 
            initFirebase();
        });

        /**
         * åˆå§‹åŒ–ç¯„ä¾‹æ•¸æ“šï¼ˆåƒ…åœ¨æ–‡ä»¶ä¸å­˜åœ¨æ™‚å¯«å…¥ï¼‰
         */
        const initializeInitialData = async () => {
            if (!isAuthReady || !userId) return;

            const path = getItineraryCollectionPath();
            if (!path) return;

            const initialData = {
                "01/04": [
                    { time: "14:00", activity: "æŠµé”æ–°åƒæ­²æ©Ÿå ´ (CTS)", location: "æ–°åƒæ­²æ©Ÿå ´", details: "è¾¦ç†å…¥å¢ƒæ‰‹çºŒã€‚\næ­ä¹˜ JR å¿«é€Ÿ Airport ç·šè‡³æœ­å¹Œã€‚", id: crypto.randomUUID() },
                    { time: "17:00", activity: "æœ­å¹Œå¸‚å€ Check-in", location: "JR æœ­å¹Œç«™", details: "æ”¾ä¸‹è¡Œæï¼Œæº–å‚™å¤–å‡ºç”¨é¤ã€‚", id: crypto.randomUUID() },
                    { time: "19:30", activity: "æ™šé¤ï¼šæœ­å¹Œæ‹‰éºµæ©«ä¸", location: "æ‹‰éºµæ©«ä¸", details: "å“åšå‘³å™Œæ‹‰éºµï¼Œæ„Ÿå—æœ­å¹Œå†¬å¤œçš„æº«æš–ã€‚", id: crypto.randomUUID() }
                ],
                "01/05": [
                    { time: "10:00", activity: "å‰å¾€å°æ¨½é‹æ²³", location: "å°æ¨½é‹æ²³", details: "å¾æœ­å¹Œæ­ä¹˜ JR ç´„ 40 åˆ†é˜ã€‚å†¬å­£é‹æ²³æ—æœ‰ç©é›ªã€‚", id: crypto.randomUUID() },
                    { time: "12:30", activity: "åˆé¤ï¼šå°æ¨½å£½å¸è¡—", location: "å°æ¨½å£½å¸é€š", details: "é¸æ“‡ä¸€å®¶è€å­—è™Ÿå£½å¸åº—ã€‚", id: crypto.randomUUID() },
                    { time: "15:00", activity: "åŒ—ä¸€ç¡å­é¤¨èˆ‡å…«éŸ³ç›’é¤¨", location: "åŒ—ä¸€ç¡å­", details: "åƒè§€ç»ç’ƒå·¥è—å“å’Œå……æ»¿æ‡·èˆŠæ°£æ¯çš„éŸ³æ¨‚ç›’ã€‚", id: crypto.randomUUID() },
                    { time: "18:00", activity: "è¿”å›æœ­å¹Œ", location: "æœ­å¹Œç«™", details: "åœ¨ç«™å‰å¤§ä¸¸ç™¾è²¨é€›é€›ã€‚", id: crypto.randomUUID() }
                ],
                "01/06": [
                    { time: "10:30", activity: "æœ­å¹Œåœ°æ¨™å·¡ç¦®", location: "æœ­å¹Œæ™‚è¨ˆå°", details: "åœ¨é›ªæ™¯ä¸­æ‹ç…§ç•™å¿µã€‚", id: crypto.randomUUID() },
                    { time: "12:30", activity: "åˆé¤ï¼šäºŒæ¢å¸‚å ´", location: "äºŒæ¢å¸‚å ´", details: "äº«ç”¨æ–°é®®æµ·é®®è“‹é£¯ã€‚", id: crypto.randomUUID() },
                    { time: "15:00", activity: "å¤§é€šå…¬åœ’èˆ‡é›»è¦–å¡”", location: "å¤§é€šå…¬åœ’", details: "ç‚ºå³å°‡åˆ°ä¾†çš„æœ­å¹Œé›ªç¥­å‹˜æ™¯ã€‚", id: crypto.randomUUID() },
                    { time: "19:00", activity: "æ™šé¤ï¼šæˆå‰æ€æ±—çƒ¤ç¾Šè‚‰", location: "è–„é‡", details: "å“åšåŒ—æµ·é“çš„ç‰¹è‰²çƒ¤ç¾Šè‚‰ (Genghis Khan BBQ)ã€‚", id: crypto.randomUUID() }
                ]
            };

            let hasError = false;
            for (const date of dates) {
                if (hasError) break; // è‹¥å·²å‡ºéŒ¯ï¼Œåœæ­¢å¾ŒçºŒè«‹æ±‚

                const docId = date.replace('/', '-'); 
                const docRef = doc(db, path, docId);
                try {
                    const docSnap = await getDoc(docRef);
                    if (!docSnap.exists()) {
                        console.log(`Setting initial data for ${date}.`);
                        await setDoc(docRef, { items: initialData[date] || [] });
                    }
                } catch (error) {
                    // è‹¥åµæ¸¬åˆ°æ¬Šé™éŒ¯èª¤
                    if (error.code === 'permission-denied') {
                        console.error(`Permission Denied at ${date}:`, error);
                        showPermissionErrorModal();
                        hasError = true;
                    } 
                    // è‹¥åµæ¸¬åˆ°é›¢ç·šéŒ¯èª¤
                    else if (error.message.includes('offline') || error.code === 'unavailable') {
                        console.error(`Firebase Offline/Unavailable Error at ${date}:`, error);
                        showStatusMessage(`
                            <strong>âš ï¸ ç„¡æ³•é€£æ¥è³‡æ–™åº«</strong><br/>
                            è«‹ç¢ºèªæ‚¨å·²åœ¨ Firebase Console å»ºç«‹ <strong>Cloud Firestore</strong> è³‡æ–™åº«ã€‚<br/>
                            <span class="text-xs">(å·¦å´é¸å–® Build > Firestore Database > Create database)</span>
                        `, true);
                        hasError = true;
                    } else {
                        console.error(`Error initializing initial data for ${date}:`, error);
                    }
                }
            }
        };

        // --- å®¢è£½åŒ–ç¢ºèªå½ˆçª—é‚è¼¯ ---
        const customConfirmModal = document.getElementById('custom-confirm-modal');
        const confirmMessageEl = document.getElementById('confirm-message');
        const confirmYesBtn = document.getElementById('confirm-yes');
        const confirmNoBtn = document.getElementById('confirm-no');
        let resolveConfirmPromise;

        const showCustomConfirm = (message) => {
            confirmMessageEl.textContent = message;
            customConfirmModal.classList.remove('hidden');
            return new Promise((resolve) => { resolveConfirmPromise = resolve; });
        };

        confirmYesBtn.addEventListener('click', () => {
            customConfirmModal.classList.add('hidden');
            if (resolveConfirmPromise) resolveConfirmPromise(true);
        });

        confirmNoBtn.addEventListener('click', () => {
            customConfirmModal.classList.add('hidden');
            if (resolveConfirmPromise) resolveConfirmPromise(false);
        });

    </script>

    <style>
        body { font-family: 'Inter', sans-serif; transition: background-color 0.3s; }
        ::-webkit-scrollbar { display: none; }
        .itinerary-grid { display: grid; grid-template-columns: 1fr; gap: 1.5rem; position: relative; padding-left: 20px; }
        .itinerary-grid::before { content: ''; position: absolute; top: 0; left: 20px; width: 2px; background-color: #1f2937; z-index: 0; height: 100%; }
        .itinerary-grid > div { position: relative; margin-left: 20px; padding-left: 20px; }
        .itinerary-grid > div::before { content: ''; position: absolute; left: -12px; top: 1.5rem; width: 12px; height: 12px; background-color: #f59e0b; border-radius: 50%; border: 4px solid #030712; z-index: 10; }
        #date-nav { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .markdown-body h1, .markdown-body h2, .markdown-body h3 { color: #fbbf24; font-weight: bold; margin-top: 1em; margin-bottom: 0.5em; }
        .markdown-body p { margin-bottom: 0.8em; line-height: 1.6; }
        .markdown-body ul, .markdown-body ol { padding-left: 1.5em; margin-bottom: 0.8em; }
        .markdown-body li { list-style-type: disc; }
        .markdown-body strong { color: #f59e0b; }
    </style>
</head>
<body class="bg-gray-950 text-white min-h-screen">

    <div class="max-w-4xl mx-auto">
        <div class="sticky top-0 z-50 bg-gray-950 pt-4 sm:pt-8 px-4 sm:px-8 pb-2 shadow-lg border-b border-gray-800/50">
            <header class="mb-4">
                <h1 class="text-3xl sm:text-4xl font-extrabold tracking-tight text-amber-400">2026åŒ—æµ·é“è¡Œç¨‹è¦åŠƒå™¨</h1>
                <p class="text-sm text-gray-400 mt-1" id="user-id-display">ä½¿ç”¨è€… ID: è¼‰å…¥ä¸­...</p>
            </header>
            <nav id="date-nav" class="flex space-x-3 p-2 bg-gray-900 rounded-xl shadow-inner"></nav>
        </div>

        <div class="p-4 sm:p-8 pt-6">
            <div class="mb-4">
                <button id="google-map-btn" onclick="openGoogleMapsRoute()" class="w-full bg-gray-900 hover:bg-gray-800 border border-amber-600 text-amber-500 hover:text-amber-400 font-bold py-4 px-4 rounded-xl shadow-lg transition duration-300 flex items-center justify-center">
                    <span class="material-icons mr-2">map</span>åœ¨ Google åœ°åœ–æŸ¥çœ‹è·¯ç·š
                </button>
                
                <!-- èˆªç­è³‡è¨Šå¡ç‰‡ (å‹•æ…‹é¡¯ç¤º) -->
                <div id="flight-info-card" class="mt-4 hidden bg-gray-800 rounded-xl p-4 shadow-lg border border-gray-700">
                    <!-- å…§å®¹ç”± JS å¡«å…… -->
                </div>
            </div>

            <main class="mb-24">
                <h2 id="current-date-title" class="text-2xl font-bold text-white mb-6">01/04 è¡Œç¨‹</h2>
                <div id="itinerary-list" class="itinerary-grid">
                    <div class="text-gray-500 p-4">è¼‰å…¥ä¸­...</div>
                </div>
            </main>

            <div id="status-message" class="fixed bottom-2 left-1/2 transform -translate-x-1/2 bg-yellow-600 text-white text-sm px-4 py-2 rounded-lg shadow-xl hidden"></div>

            <button id="add-fab" onclick="openAddModal()"
                class="fixed bottom-8 right-8 bg-amber-500 hover:bg-amber-600 text-white w-14 h-14 flex items-center justify-center rounded-2xl shadow-2xl transition duration-300 ease-in-out transform hover:scale-110 focus:outline-none focus:ring-4 focus:ring-amber-500 focus:ring-opacity-50 z-40">
                <span class="material-icons text-3xl">add</span>
            </button>
        </div>
    </div>

    <!-- æ¬Šé™éŒ¯èª¤æ•™å­¸æ¨¡æ…‹æ¡† -->
    <div id="permission-modal" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-[70] hidden">
        <div class="bg-white text-gray-900 rounded-xl shadow-2xl w-11/12 max-w-2xl p-6 relative max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold mb-4 text-red-600 flex items-center">
                <span class="material-icons mr-2">gpp_bad</span> éœ€è¦è¨­å®šè³‡æ–™åº«æ¬Šé™
            </h3>
            
            <p class="mb-4 text-gray-700">æ‚¨é‡åˆ° <code>Missing or insufficient permissions</code> éŒ¯èª¤ï¼Œé€™ä»£è¡¨æ‚¨çš„ Firebase è³‡æ–™åº«å®‰å…¨è¦å‰‡å°šæœªè¨­å®šï¼Œæ‹’çµ•äº†å¯«å…¥è«‹æ±‚ã€‚</p>
            
            <div class="bg-gray-100 p-4 rounded-lg border border-gray-200 mb-4">
                <h4 class="font-bold mb-2 flex items-center text-sm text-gray-600">
                    <span class="material-icons text-sm mr-1">content_copy</span> è«‹è¤‡è£½ä»¥ä¸‹è¦å‰‡ä»£ç¢¼ï¼š
                </h4>
                <pre id="rules-code" class="bg-gray-800 text-green-400 p-4 rounded text-sm overflow-x-auto font-mono">rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /artifacts/{appId}/users/{userId}/{document=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
  }
}</pre>
                <button id="copy-rules-btn" onclick="copyRules()" class="mt-2 w-full py-2 bg-blue-600 hover:bg-blue-700 text-white rounded font-bold transition-colors flex items-center justify-center">
                    <span class="material-icons text-sm mr-1">content_copy</span> è¤‡è£½ä»£ç¢¼
                </button>
            </div>
            
            <div class="space-y-2 text-sm text-gray-600">
                <p class="font-bold">è¨­å®šæ­¥é©Ÿï¼š</p>
                <ol class="list-decimal list-inside space-y-1 ml-2">
                    <li>å‰å¾€ <a href="https://console.firebase.google.com/" target="_blank" class="text-blue-600 underline">Firebase Console</a>ã€‚</li>
                    <li>é»é¸æ‚¨çš„å°ˆæ¡ˆ (<strong>hokkaido-fc132</strong>)ã€‚</li>
                    <li>å·¦å´é¸å–®é»é¸ <strong>Build</strong> > <strong>Firestore Database</strong>ã€‚</li>
                    <li>é»é¸ä¸Šæ–¹çš„ <strong>Rules (è¦å‰‡)</strong> æ¨™ç±¤ã€‚</li>
                    <li>åˆªé™¤åŸæœ¬çš„å…§å®¹ï¼Œ<strong>è²¼ä¸Š</strong>å‰›å‰›è¤‡è£½çš„ä»£ç¢¼ã€‚</li>
                    <li>é»æ“Š <strong>Publish (ç™¼å¸ƒ)</strong> æŒ‰éˆ•ã€‚</li>
                </ol>
            </div>

            <div class="mt-6 text-center">
                <button onclick="closePermissionModal()" class="w-full py-3 bg-gray-800 hover:bg-gray-700 text-white rounded-lg transition-colors font-bold">
                    æˆ‘å·²å®Œæˆè¨­å®šï¼Œé—œé–‰è¦–çª—
                </button>
            </div>
        </div>
    </div>

    <!-- è¡Œç¨‹æ–°å¢/ç·¨è¼¯æ¨¡æ…‹æ¡† -->
    <div id="itinerary-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-900 rounded-xl shadow-2xl w-[95%] sm:w-11/12 max-w-lg p-4 sm:p-6 relative">
            <h3 id="modal-title" class="text-2xl font-bold mb-4 text-amber-400">æ–°å¢è¡Œç¨‹é …ç›®</h3>
            <form id="itinerary-form">
                <div class="mb-4">
                    <label for="time" class="block text-sm font-medium text-gray-300 mb-1">æ™‚é–“ (HH:MM)</label>
                    <input type="time" id="time" class="w-full max-w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white focus:ring-amber-500 focus:border-amber-500 appearance-none">
                </div>
                <div class="mb-4">
                    <label for="activity" class="block text-sm font-medium text-gray-300 mb-1">æ´»å‹•åç¨± *</label>
                    <input type="text" id="activity" required class="w-full max-w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white focus:ring-amber-500 focus:border-amber-500">
                </div>
                <div class="mb-4">
                    <label for="location" class="block text-sm font-medium text-gray-300 mb-1">åœ°é»</label>
                    <div class="flex space-x-2">
                        <input type="text" id="location" placeholder="ä¾‹å¦‚ï¼šæœ­å¹Œé›»è¦–å¡”" class="flex-grow min-w-0 p-3 rounded-lg bg-gray-800 border border-gray-700 text-white focus:ring-amber-500 focus:border-amber-500">
                        <button type="button" onclick="searchLocationOnMap()" class="flex-shrink-0 bg-gray-700 hover:bg-gray-600 border border-gray-600 text-gray-300 hover:text-white p-3 rounded-lg transition-colors flex items-center justify-center" title="åœ¨ Google Maps ä¸Šæœå°‹ç¢ºèªåº—å">
                            <span class="material-icons">search</span>
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">ğŸ’¡ è¼¸å…¥é—œéµå­—å¾Œé»æ“Šæœå°‹ï¼Œç¢ºèªç¢ºåˆ‡åº—åå¾Œå¡«å…¥ï¼Œå°èˆªæ›´æº–ç¢ºã€‚</p>
                </div>
                <div class="mb-6">
                    <label for="details" class="block text-sm font-medium text-gray-300 mb-1">è©³ç´°èªªæ˜</label>
                    <textarea id="details" rows="3" class="w-full max-w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white focus:ring-amber-500 focus:border-amber-500"></textarea>
                </div>
                <div class="flex flex-col sm:flex-row justify-between space-y-3 sm:space-y-0 sm:space-x-3">
                    <button type="button" id="delete-btn" class="hidden w-full sm:w-auto px-4 py-3 text-sm font-semibold rounded-lg bg-red-600 hover:bg-red-700 transition duration-150 text-white">åˆªé™¤</button>
                    <div class="flex space-x-3 w-full sm:w-auto">
                        <button type="button" onclick="closeModal()" class="w-full px-4 py-3 text-sm font-semibold rounded-lg bg-gray-700 hover:bg-gray-600 transition duration-150 text-white">å–æ¶ˆ</button>
                        <button type="submit" class="w-full px-4 py-3 text-sm font-semibold rounded-lg bg-amber-500 hover:bg-amber-600 transition duration-150 text-white">å„²å­˜</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- å®¢è£½åŒ–ç¢ºèªå½ˆçª— -->
    <div id="custom-confirm-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[60] hidden">
        <div class="bg-gray-900 rounded-xl shadow-2xl w-11/12 max-w-sm p-6">
            <h4 class="text-xl font-bold mb-4 text-red-400">ç¢ºèªæ“ä½œ</h4>
            <p id="confirm-message" class="text-gray-300 mb-6">ç¢ºå®šè¦åŸ·è¡Œæ­¤æ“ä½œå—ï¼Ÿ</p>
            <div class="flex justify-end space-x-3">
                <button id="confirm-no" class="px-4 py-2 text-sm font-semibold rounded-lg bg-gray-700 hover:bg-gray-600 transition duration-150 text-white">å–æ¶ˆ</button>
                <button id="confirm-yes" class="px-4 py-2 text-sm font-semibold rounded-lg bg-red-600 hover:bg-red-700 transition duration-150 text-white">ç¢ºèªåˆªé™¤</button>
            </div>
        </div>
    </div>

</body>
</html>
