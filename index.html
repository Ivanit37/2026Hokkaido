<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>北海盜</title>
    <!-- 網站圖示 (Favicon) -->
    <link rel="icon" href="hokicon.jpg" type="image/jpeg">
    
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 引入 Google Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot, getDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 設定 Firebase Debug Log
        setLogLevel('silent'); 

        // 全域變數
        const appId = typeof __app_id !== 'undefined' ? __app_id : '2026hokkaido';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; 
        
        // --- Firebase 設定 ---
        const firebaseConfig = {
            apiKey: "AIzaSyBsHR53LDslQL5D9_l79wJA7NUOe8mrCe8",
            authDomain: "hokkaido-fc132.firebaseapp.com",
            projectId: "hokkaido-fc132",
            storageBucket: "hokkaido-fc132.firebasestorage.app",
            messagingSenderId: "107783904784",
            appId: "1:107783904784:web:3635a0aca3fd8478a03495",
        };
        
        let app, db, auth;
        let userId = null;
        let currentDataId = null; 
        let isAuthReady = false;

        // UI 變數 (延後初始化)
        let modal, modalForm, modalTitle;
        let editingIndex = null; 
        
        // 初始化 Firebase
        if (Object.keys(firebaseConfig).length > 0) {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
            } catch (e) {
                console.error("Firebase Initialization Error:", e);
                // 這裡還不能呼叫 UI 相關函式，因為 DOM 可能還沒好
            }
        } else {
            console.error("Firebase Configuration is missing.");
        }

        /**
         * 顯示狀態訊息的輔助函式 (iOS Toast 風格)
         */
        const showStatusMessage = (htmlContent, isError = false) => {
            const statusMsg = document.getElementById('status-message');
            if (statusMsg) {
                statusMsg.innerHTML = htmlContent;
                statusMsg.classList.remove('hidden', 'opacity-0', 'translate-y-4');
                
                // 根據類型設定樣式
                if (isError) {
                    statusMsg.className = "fixed bottom-8 left-1/2 transform -translate-x-1/2 bg-red-500/90 backdrop-blur-md text-white text-[15px] font-medium px-6 py-3 rounded-full shadow-2xl z-50 transition-all duration-300";
                } else {
                    statusMsg.className = "fixed bottom-8 left-1/2 transform -translate-x-1/2 bg-zinc-800/90 backdrop-blur-md text-white text-[15px] font-medium px-6 py-3 rounded-full shadow-2xl z-50 transition-all duration-300 border border-white/10";
                }

                // 3秒後自動消失
                setTimeout(() => {
                    statusMsg.classList.add('opacity-0', 'translate-y-4');
                    setTimeout(() => statusMsg.classList.add('hidden'), 300);
                }, 3000);
            }
        };

        const showPermissionErrorModal = () => {
            const modal = document.getElementById('permission-modal');
            if(modal) modal.classList.remove('hidden');
        };

        const initFirebase = async () => {
            if (!app || !db || !auth) return;

            try {
                if (initialAuthToken) {
                    try {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } catch (tokenError) {
                        await signInAnonymously(auth);
                    }
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase Auth failed:", error);
                showStatusMessage(`登入失敗: ${error.message}`, true);
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    
                    // 1. 檢查網址參數 (?trip=xxx) - 新增功能
                    const urlParams = new URLSearchParams(window.location.search);
                    const linkTripId = urlParams.get('trip');

                    // 2. 檢查 LocalStorage
                    const savedTripId = localStorage.getItem('custom_trip_id');
                    
                    // 優先級: 網址參數 > LocalStorage > 原生 UserID
                    if (linkTripId) {
                        currentDataId = linkTripId;
                        // 如果網址有帶參數，順便存入 LocalStorage，這樣下次沒帶參數也能記住
                        localStorage.setItem('custom_trip_id', linkTripId);
                    } else {
                        currentDataId = savedTripId || userId;
                    }
                    
                    updateSyncUI(); // 更新介面顯示 ID
                    loadItinerary(window.selectedDate);
                } else {
                    userId = null;
                    isAuthReady = true;
                }
            });
        };

        const getItineraryCollectionPath = () => {
            if (!currentDataId) return null;
            // 使用 currentDataId 而不是 userId，實現跨帳號存取
            return `artifacts/${appId}/users/${currentDataId}/hokkaido_itinerary`;
        };

        window.openGoogleMapsRoute = () => {
            const items = window.currentItinerary || [];
            const locations = items
                .filter(item => item.location && item.location.trim() !== "")
                .sort((a, b) => (a.time || '').localeCompare(b.time || ''))
                .map(item => item.location.trim());

            if (locations.length === 0) { 
                showStatusMessage("行程中沒有地點資訊", true); 
                return; 
            }

            let url = "";
            if (locations.length === 1) {
                const query = encodeURIComponent(locations[0]);
                url = `https://www.google.com/maps/search/?api=1&query=${query}`;
            } else {
                const origin = encodeURIComponent(locations[0]);
                const destination = encodeURIComponent(locations[locations.length - 1]);
                let waypoints = "";
                if (locations.length > 2) {
                    const waypointList = locations.slice(1, locations.length - 1).map(loc => encodeURIComponent(loc));
                    waypoints = `&waypoints=${waypointList.join('|')}`;
                }
                url = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}${waypoints}`;
            }
            window.open(url, '_blank');
        };

        window.searchLocationOnMap = () => {
            const locationVal = document.getElementById('location').value.trim();
            if (locationVal) {
                window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(locationVal)}`, '_blank');
            } else {
                showStatusMessage("請先輸入地點關鍵字", true);
            }
        };

        const updateFlightInfo = (date) => {
            const flightCard = document.getElementById('flight-info-card');
            if (!flightCard) return;

            flightCard.classList.add('hidden');
            
            if (date === '01/04') {
                renderFlightCard({
                    flightNo: 'HB008', airline: 'GBA', depCity: 'HKG', arrCity: 'CTS',
                    depTime: '08:55', arrTime: '14:50', link: 'https://www.flightradar24.com/data/flights/hb8'
                });
                flightCard.classList.remove('hidden');
            } else if (date === '01/11') {
                renderFlightCard({
                    flightNo: 'HB009', airline: 'GBA', depCity: 'CTS', arrCity: 'HKG',
                    depTime: '15:50', arrTime: '21:00', link: 'https://www.flightradar24.com/data/flights/hb9'
                });
                flightCard.classList.remove('hidden');
            }
        };

        const renderFlightCard = (data) => {
            const container = document.getElementById('flight-info-card');
            if(!container) return;

            container.innerHTML = `
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center space-x-2">
                        <span class="material-icons text-white/70 text-sm rotate-90">flight</span>
                        <span class="font-semibold text-white tracking-wide">${data.flightNo}</span>
                    </div>
                    <span class="text-[11px] font-bold bg-white text-black px-2 py-0.5 rounded-full">${data.airline}</span>
                </div>
                
                <div class="flex justify-between items-center text-center mb-5 relative">
                    <!-- 連接線 -->
                    <div class="absolute top-1/2 left-10 right-10 h-[1px] bg-zinc-700 -z-10"></div>

                    <div class="bg-[#1c1c1e] px-2 z-10">
                        <div class="text-[32px] font-light text-white tracking-tight">${data.depTime}</div>
                        <div class="text-[13px] text-zinc-500 font-medium mt-0.5 tracking-wide">${data.depCity}</div>
                    </div>
                    
                    <div class="bg-[#1c1c1e] px-2 z-10">
                        <div class="text-[32px] font-light text-white tracking-tight">${data.arrTime}</div>
                        <div class="text-[13px] text-zinc-500 font-medium mt-0.5 tracking-wide">${data.arrCity}</div>
                    </div>
                </div>

                <a href="${data.link}" target="_blank" class="block w-full text-center bg-zinc-800 hover:bg-zinc-700 text-white text-[13px] font-medium py-3 rounded-xl transition-all active:scale-[0.98]">
                    查看航班動態
                </a>
            `;
        };

        const loadItinerary = (date) => {
            const itineraryContainer = document.getElementById('itinerary-list');
            if(!itineraryContainer) return;

            itineraryContainer.innerHTML = '<div class="text-zinc-500 text-center py-10 text-[15px]">載入中...</div>';

            // 需要清除舊的監聽器，因為 DataId 可能變了
            if (window.itineraryUnsubscribe) {
                window.itineraryUnsubscribe();
                window.itineraryUnsubscribe = null;
            }

            if (!isAuthReady || !currentDataId) return;
            const path = getItineraryCollectionPath();
            if (!path) return;

            const docId = date.replace('/', '-'); 
            const docRef = doc(db, path, docId);
            
            window.itineraryUnsubscribe = onSnapshot(docRef, (docSnap) => {
                const itineraryList = docSnap.exists() ? docSnap.data().items : [];
                window.currentItinerary = itineraryList;
                renderItinerary(itineraryList);
                updateMapButtonState(itineraryList);
            }, (error) => {
                console.error("Error:", error);
                if (error.code === 'permission-denied') showPermissionErrorModal();
                else if (error.message.includes('offline')) showStatusMessage("離線模式 - 無法連接資料庫", true);
            });
        };

        const updateMapButtonState = (items) => {
            const btn = document.getElementById('google-map-btn');
            if(!btn) return;
            const hasLocations = items.some(item => item.location && item.location.trim() !== "");
            
            if (hasLocations) {
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
                btn.disabled = false;
            } else {
                btn.classList.add('opacity-50', 'cursor-not-allowed');
                btn.disabled = true;
            }
        };

        const renderItinerary = (items) => {
            const itineraryContainer = document.getElementById('itinerary-list');
            if(!itineraryContainer) return;
            itineraryContainer.innerHTML = '';

            if (items.length === 0) {
                itineraryContainer.innerHTML = `
                    <div class="text-center py-20">
                        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-zinc-900 mb-4">
                            <span class="material-icons text-zinc-600 text-2xl">calendar_today</span>
                        </div>
                        <p class="text-zinc-500 text-[15px]">本日尚無行程</p>
                    </div>
                `;
                return;
            }

            items.sort((a, b) => (a.time || '').localeCompare(b.time || ''));

            items.forEach((item, index) => {
                const card = document.createElement('div');
                // iOS Card Style: Dark Gray Background, No Border, Rounded-2xl
                card.className = 'ios-card bg-[#1c1c1e] p-5 rounded-2xl mb-4 transition-transform duration-200 active:scale-[0.98] cursor-pointer group relative overflow-hidden';
                
                const locationDisplay = item.location ? 
                    `<div class="flex items-center mt-2 text-zinc-500">
                        <span class="material-icons text-[14px] mr-1">place</span>
                        <span class="text-[13px] font-medium">${item.location}</span>
                     </div>` : '';

                // 右上角操作按鈕 (預設隱藏，點擊或 hover 顯示)
                const actionsHtml = `
                    <div class="absolute top-4 right-4 flex space-x-2">
                        ${item.location ? `
                        <button class="map-item-btn w-8 h-8 flex items-center justify-center rounded-full bg-zinc-800 text-white hover:bg-zinc-700 transition-colors" title="地圖">
                            <span class="material-icons text-[16px]">map</span>
                        </button>` : ''}
                        <button class="edit-btn w-8 h-8 flex items-center justify-center rounded-full bg-zinc-800 text-white hover:bg-zinc-700 transition-colors" data-index="${index}" title="編輯">
                            <span class="material-icons text-[16px]">edit</span>
                        </button>
                    </div>
                `;

                card.innerHTML = `
                    <div class="flex items-start">
                        <!-- 時間軸圓點與線條是透過外部 CSS 處理，這裡只保留內容 -->
                        <div class="flex-grow pr-12"> <!-- pr-12 留空間給按鈕 -->
                            <p class="text-[15px] font-semibold text-zinc-400 tracking-wide mb-1 font-numeric">${item.time || '--:--'}</p>
                            <h3 class="text-[17px] font-semibold text-white leading-tight">
                                ${item.activity || '未命名活動'}
                            </h3>
                            ${locationDisplay}
                            ${item.details ? `<p class="text-[15px] text-zinc-400 mt-3 leading-relaxed border-t border-zinc-800/50 pt-3">${item.details}</p>` : ''}
                        </div>
                        ${actionsHtml}
                    </div>
                `;
                
                card.addEventListener('click', (e) => {
                    // 如果點擊的是按鈕，不觸發卡片點擊
                    if(e.target.closest('button')) return;
                    openEditModal(index);
                });

                const editBtn = card.querySelector('.edit-btn');
                if (editBtn) editBtn.addEventListener('click', (e) => { e.stopPropagation(); openEditModal(index); });
                
                const mapBtn = card.querySelector('.map-item-btn');
                if (mapBtn) mapBtn.addEventListener('click', (e) => { 
                    e.stopPropagation(); 
                    window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.location)}`, '_blank'); 
                });

                itineraryContainer.appendChild(card);
            });
        };

        const saveItinerary = async (date, items) => {
            if (!isAuthReady || !currentDataId) { showStatusMessage('錯誤：尚未就緒', true); return; }
            const path = getItineraryCollectionPath();
            if (!path) return;
            const docId = date.replace('/', '-'); 
            const docRef = doc(db, path, docId);
            try {
                await setDoc(docRef, { items: items }, { merge: true });
            } catch (error) {
                if (error.code === 'permission-denied') showPermissionErrorModal();
                else showStatusMessage(`儲存失敗: ${error.message}`, true);
            }
        };

        // --- Sync Logic ---
        window.openSyncModal = () => {
            const modal = document.getElementById('sync-modal');
            if(!modal) return;
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.querySelector('.modal-content').classList.remove('scale-95', 'opacity-0');
                modal.querySelector('.modal-content').classList.add('scale-100', 'opacity-100');
            }, 10);
            
            // 填入當前 ID
            const idInput = document.getElementById('current-trip-id');
            if(idInput) idInput.value = currentDataId || 'Loading...';
        };

        window.closeSyncModal = () => {
            const modal = document.getElementById('sync-modal');
            if(!modal) return;
            const content = modal.querySelector('.modal-content');
            content.classList.remove('scale-100', 'opacity-100');
            content.classList.add('scale-95', 'opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 200);
        };

        /**
         * 執行複製的通用函式，自動處理權限問題
         */
        const executeCopy = (text, successMessage) => {
            // 方法：使用 execCommand 備案 (相容性最高，避免 iFrame 權限問題)
            const textArea = document.createElement("textarea");
            textArea.value = text;
            
            // 確保元素不可見但存在於 DOM
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            textArea.style.top = "0";
            document.body.appendChild(textArea);
            
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showStatusMessage(successMessage);
                } else {
                    showStatusMessage("複製失敗，請手動複製", true);
                }
            } catch (err) {
                console.error('Fallback copy error:', err);
                showStatusMessage("複製失敗，請手動複製", true);
            }
            
            document.body.removeChild(textArea);
        };

        window.copyTripId = () => {
            const idInput = document.getElementById('current-trip-id');
            if(idInput) executeCopy(idInput.value, "已複製行程代碼");
        };
        
        // 新增：複製完整行程連結
        window.copyTripLink = () => {
            const idInput = document.getElementById('current-trip-id');
            if (!idInput) return;
            const id = idInput.value;
            // 確保網址正確，加上 ?trip=ID
            const url = `${window.location.origin}${window.location.pathname}?trip=${id}`;
            executeCopy(url, "已複製行程連結");
        };

        window.copyRules = () => {
            const rulesText = document.getElementById('rules-code');
            if(rulesText) executeCopy(rulesText.innerText, "已複製規則代碼");
        };

        window.loadSharedTrip = () => {
            const idInput = document.getElementById('shared-trip-id');
            if(!idInput) return;
            const inputId = idInput.value.trim();

            if (!inputId) {
                showStatusMessage("請輸入行程代碼", true);
                return;
            }
            
            // 儲存到 localStorage 並更新狀態
            localStorage.setItem('custom_trip_id', inputId);
            currentDataId = inputId;
            updateSyncUI();
            
            // 重新載入資料
            loadItinerary(window.selectedDate);
            closeSyncModal();
            showStatusMessage("已切換至共享行程");
        };

        window.resetToMyTrip = () => {
            localStorage.removeItem('custom_trip_id');
            currentDataId = userId;
            updateSyncUI();
            loadItinerary(window.selectedDate);
            closeSyncModal();
            showStatusMessage("已切換回我的行程");
        };

        const updateSyncUI = () => {
            // 更新 UI 顯示目前是否在共享模式
            // 這裡可以做一些視覺上的變化，目前先保持簡單
            console.log("Current Data ID:", currentDataId);
        };

        // --- Modal ---
        
        window.openAddModal = () => {
            editingIndex = null;
            if(modalTitle) modalTitle.textContent = '新增行程';
            if(modalForm) modalForm.reset();
            openModalAnimation();
        };

        const openEditModal = (index) => {
            editingIndex = index;
            if(modalTitle) modalTitle.textContent = '編輯行程';
            const item = window.currentItinerary[index];
            
            const setVal = (id, val) => {
                const el = document.getElementById(id);
                if(el) el.value = val;
            };

            setVal('time', item.time || '');
            setVal('activity', item.activity || '');
            setVal('location', item.location || '');
            setVal('details', item.details || '');
            
            const deleteBtn = document.getElementById('delete-btn');
            if(deleteBtn) deleteBtn.classList.remove('hidden');
            openModalAnimation();
        };

        const openModalAnimation = () => {
            if(!modal) return;
            modal.classList.remove('hidden');
            // 簡單的淡入動畫
            setTimeout(() => {
                modal.querySelector('.modal-content').classList.remove('scale-95', 'opacity-0');
                modal.querySelector('.modal-content').classList.add('scale-100', 'opacity-100');
            }, 10);
        };

        window.closeModal = () => {
            if(!modal) return;
            const content = modal.querySelector('.modal-content');
            content.classList.remove('scale-100', 'opacity-100');
            content.classList.add('scale-95', 'opacity-0');
            
            setTimeout(() => {
                modal.classList.add('hidden');
                const deleteBtn = document.getElementById('delete-btn');
                if(deleteBtn) deleteBtn.classList.add('hidden');
                if(modalForm) modalForm.reset();
            }, 200);
        };

        window.closePermissionModal = () => {
             const modal = document.getElementById('permission-modal');
             if(modal) modal.classList.add('hidden');
        };

        // --- Date Logic ---
        const dates = ["01/04", "01/05", "01/06", "01/07", "01/08", "01/09", "01/10", "01/11"];
        window.selectedDate = dates[0]; 

        window.selectDate = (date) => {
            if (window.itineraryUnsubscribe) window.itineraryUnsubscribe();
            window.selectedDate = date;
            
            // iOS Segment Control Style Update
            document.querySelectorAll('.date-btn').forEach(btn => {
                btn.classList.remove('bg-white', 'text-black', 'shadow-md');
                btn.classList.add('text-zinc-500', 'hover:text-zinc-300');
            });
            const activeBtn = document.getElementById(`date-${date.replace('/', '-')}`);
            if(activeBtn) {
                activeBtn.classList.remove('text-zinc-500', 'hover:text-zinc-300');
                activeBtn.classList.add('bg-white', 'text-black', 'shadow-md');
            }

            // document.getElementById('current-date-title').textContent = `${date} 行程`;
            updateFlightInfo(date);
            if (isAuthReady) loadItinerary(date);
        };

        // DOMContentLoaded: 確保 DOM 準備好再執行 UI 綁定
        document.addEventListener('DOMContentLoaded', () => {
            // 初始化 UI 元素
            modal = document.getElementById('itinerary-modal');
            modalForm = document.getElementById('itinerary-form');
            modalTitle = document.getElementById('modal-title');
            
            // 綁定 Event Listeners
            if (modalForm) {
                modalForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const getVal = (id) => {
                        const el = document.getElementById(id);
                        return el ? el.value.trim() : '';
                    };

                    const time = getVal('time');
                    const activity = getVal('activity');
                    const location = getVal('location');
                    const details = getVal('details');
                    
                    if (!activity) { showStatusMessage('請輸入活動名稱', true); return; }
                    
                    const newItem = { 
                        time, activity, location, details, 
                        id: editingIndex !== null ? window.currentItinerary[editingIndex].id : crypto.randomUUID() 
                    };
                    
                    let updatedItems = [...(window.currentItinerary || [])];
                    if (editingIndex !== null) { updatedItems[editingIndex] = newItem; } else { updatedItems.push(newItem); }

                    await saveItinerary(window.selectedDate, updatedItems);
                    window.closeModal();
                });
            }

            const deleteBtn = document.getElementById('delete-btn');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', async () => {
                    if (editingIndex !== null) {
                        if (confirm("確定要刪除此行程嗎？")) {
                            const updatedItems = [...(window.currentItinerary || [])];
                            updatedItems.splice(editingIndex, 1);
                            await saveItinerary(window.selectedDate, updatedItems);
                            window.closeModal();
                        }
                    }
                });
            }

            const dateNav = document.getElementById('date-nav');
            if (dateNav) {
                dates.forEach(date => {
                    const btn = document.createElement('button');
                    btn.id = `date-${date.replace('/', '-')}`;
                    // iOS Pill Style
                    btn.className = `date-btn px-5 py-2 rounded-full text-[15px] font-semibold transition-all duration-300 ease-out whitespace-nowrap`;
                    btn.innerHTML = `<span class="opacity-60 text-[11px] block leading-none mb-0.5">${date.split('/')[0]}月</span><span class="text-[17px] block leading-none tracking-tight">${date.split('/')[1]}</span>`;
                    btn.onclick = () => window.selectDate(date);
                    dateNav.appendChild(btn);
                });
            }
            
            // 初始化預設選擇
            window.selectDate(window.selectedDate); 
            initFirebase();
        });
    </script>

    <style>
        /* iOS 深色模式字體設定 */
        body {
            /* 優先使用 Apple 系統字體，並指定 PingFang TC 作為繁中首選 */
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "PingFang TC", "Hiragino Sans GB", "Microsoft JhengHei", "Helvetica Neue", Helvetica, Arial, sans-serif;
            background-color: #000000;
            color: #ffffff;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* 數字字體優化 (使用 SF Pro 的數字樣式) */
        .font-numeric {
            font-variant-numeric: tabular-nums;
        }

        /* 隱藏捲軸但保留功能 */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* 時間軸線條 (極簡灰) */
        .itinerary-grid {
            position: relative;
            padding-left: 24px;
            padding-bottom: 40px;
        }
        .itinerary-grid::before {
            content: '';
            position: absolute;
            top: 20px;
            bottom: 20px;
            left: 7px; /* 線條位置 */
            width: 2px;
            background-color: #27272a; /* zinc-800 */
            border-radius: 99px;
            z-index: 0;
        }
        
        /* 時間軸圓點 (黑底白邊) */
        .ios-card::before {
            content: '';
            position: absolute;
            left: -21px; /* 圓點位置，相對於卡片 */
            top: 24px;
            width: 10px;
            height: 10px;
            background-color: #000000;
            border: 2px solid #52525b; /* zinc-600 */
            border-radius: 50%;
            z-index: 10;
            box-shadow: 0 0 0 4px #000000; /* 外部遮罩製造間距感 */
        }

        /* Modal 動畫與樣式 */
        .modal-content {
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        
        /* 針對輸入框的樣式優化 */
        input[type="time"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            opacity: 0.6;
        }
    </style>
</head>
<body class="min-h-screen pb-20">

    <!-- Sticky Header (iOS Blur Effect) -->
    <div class="sticky top-0 z-40 bg-black/70 backdrop-blur-xl border-b border-white/5 pb-2">
        <div class="max-w-xl mx-auto px-4 pt-12 pb-2"> <!-- pt-12 for status bar space feeling -->
            <header class="flex justify-between items-end mb-4">
                <div class="flex items-center">
                    <img src="hokicon.jpg" alt="Icon" class="w-10 h-10 rounded-full mr-3 border-2 border-white/20">
                    <div>
                        <h1 class="text-[34px] font-bold tracking-tight text-white leading-tight">北海盜</h1>
                        <p class="text-zinc-500 text-[13px] font-medium mt-0.5 tracking-wide uppercase">Hokkaido 2026>Hp>
                    </div>
                </div>
                <!-- Sync Button -->
                <button onclick="openSyncModal()" class="w-9 h-9 bg-zinc-800 rounded-full flex items-center justify-center hover:bg-zinc-700 transition-colors">
                    <span class="material-icons text-white text-[18px]">cloud_sync</span>
                </button>
            </header>

            <!-- 日期導航 (橫向捲動) -->
            <nav id="date-nav" class="flex space-x-2 overflow-x-auto no-scrollbar py-2 mask-linear"></nav>
        </div>
    </div>

    <div class="max-w-xl mx-auto px-4 pt-6">
        
        <!-- 功能按鈕區 -->
        <div class="mb-6 grid grid-cols-1 gap-4">
            <button id="google-map-btn" onclick="openGoogleMapsRoute()" class="w-full bg-[#1c1c1e] active:bg-[#2c2c2e] text-white py-4 px-4 rounded-2xl flex items-center justify-center transition-all duration-200 group">
                <div class="w-8 h-8 rounded-full bg-zinc-800 flex items-center justify-center mr-3 group-active:scale-90 transition-transform">
                    <span class="material-icons text-[15px] text-white">map</span>
                </div>
                <span class="font-medium text-[15px]">查看今日路線</span>
            </button>
            
            <!-- 航班資訊卡片 -->
            <div id="flight-info-card" class="bg-[#1c1c1e] rounded-2xl p-5 hidden">
                <!-- JS 填充 -->
            </div>
        </div>

        <!-- 行程列表 -->
        <main>
            <!-- <h2 id="current-date-title" class="text-xl font-bold text-white mb-6 pl-1">今日行程</h2> -->
            <div id="itinerary-list" class="itinerary-grid">
                <!-- JS 填充 -->
            </div>
        </main>

        <!-- 狀態訊息 (Toast) -->
        <div id="status-message" class="hidden transition-all duration-300 opacity-0 translate-y-4"></div>

        <!-- FAB (iOS style: White circle with black icon, high contrast) -->
        <button id="add-fab" onclick="openAddModal()"
            class="fixed bottom-8 right-6 w-14 h-14 bg-white text-black rounded-full shadow-[0_8px_30px_rgb(0,0,0,0.5)] flex items-center justify-center active:scale-90 transition-transform duration-300 z-40">
            <span class="material-icons text-3xl">add</span>
        </button>
    </div>

    <!-- Sync Modal -->
    <div id="sync-modal" class="fixed inset-0 z-[60] flex items-center justify-center hidden p-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeSyncModal()"></div>
        <div class="modal-content relative bg-[#1c1c1e] w-full max-w-sm rounded-3xl p-6 transform scale-95 opacity-0 shadow-2xl border border-white/10">
            <h3 class="text-xl font-bold text-white mb-4 text-center">行程同步 / 分享</h3>
            
            <!-- Current ID -->
            <div class="mb-6">
                <label class="text-xs font-medium text-zinc-400 ml-1 block mb-2">目前行程 (Current Trip)</label>
                <div class="flex space-x-2 mb-2">
                    <input type="text" id="current-trip-id" readonly class="flex-grow bg-zinc-900 text-white font-mono text-sm p-3 rounded-xl border border-zinc-800 focus:outline-none text-center">
                </div>
                <div class="flex space-x-2">
                     <button onclick="copyTripId()" class="flex-1 bg-zinc-800 text-white py-3 rounded-xl hover:bg-zinc-700 transition-colors text-xs font-medium">
                        複製代碼
                    </button>
                    <button onclick="copyTripLink()" class="flex-1 bg-white text-black py-3 rounded-xl hover:bg-gray-200 transition-colors text-xs font-bold">
                        複製完整連結
                    </button>
                </div>
                <p class="text-[10px] text-zinc-500 mt-3 text-center">使用「完整連結」加入我的最愛，下次直接點擊即可進入。</p>
            </div>

            <div class="h-[1px] bg-zinc-800 w-full mb-6"></div>

            <!-- Join Trip -->
            <div class="mb-6">
                <label class="text-xs font-medium text-zinc-400 ml-1 block mb-2">載入其他行程</label>
                <input type="text" id="shared-trip-id" placeholder="輸入行程代碼..." class="w-full bg-zinc-800/50 text-white p-3 rounded-xl focus:outline-none focus:ring-1 focus:ring-white/20 mb-3">
                <button onclick="loadSharedTrip()" class="w-full bg-white text-black py-3 rounded-xl font-bold text-sm hover:bg-gray-200 transition-colors">
                    載入行程
                </button>
            </div>

            <button onclick="resetToMyTrip()" class="w-full text-zinc-500 py-2 text-xs hover:text-white transition-colors">
                回到我的原始行程
            </button>
        </div>
    </div>

    <!-- 編輯/新增 Modal (iOS Sheet Style) -->
    <div id="itinerary-modal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center hidden">
        <!-- Backdrop -->
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeModal()"></div>
        
        <!-- Content -->
        <div class="modal-content relative bg-[#1c1c1e] w-full max-w-lg sm:rounded-3xl rounded-t-3xl p-6 sm:p-8 transform scale-95 opacity-0 shadow-2xl border-t border-white/10 sm:border-none">
            <!-- Handle bar for mobile feel -->
            <div class="w-10 h-1 bg-zinc-700 rounded-full mx-auto mb-6 sm:hidden"></div>

            <h3 id="modal-title" class="text-[22px] font-bold mb-6 text-white text-center">行程項目</h3>
            
            <form id="itinerary-form" class="space-y-5">
                <!-- 時間 -->
                <div class="bg-zinc-800/50 rounded-xl p-3 flex items-center justify-between">
                    <label class="text-[15px] font-medium text-zinc-400 ml-1">時間</label>
                    <input type="time" id="time" class="bg-transparent text-white text-right font-numeric text-[19px] focus:outline-none w-32">
                </div>
                
                <!-- 活動 -->
                <div>
                    <input type="text" id="activity" placeholder="活動名稱" class="w-full bg-zinc-800/50 text-white p-4 rounded-xl focus:outline-none focus:ring-1 focus:ring-zinc-500 placeholder-zinc-500 text-[17px] font-medium transition-all">
                </div>
                
                <!-- 地點 -->
                <div class="flex space-x-2">
                    <input type="text" id="location" placeholder="地點 (選填)" class="flex-grow bg-zinc-800/50 text-white p-4 rounded-xl focus:outline-none focus:ring-1 focus:ring-zinc-500 placeholder-zinc-500 text-[17px] transition-all">
                    <button type="button" onclick="searchLocationOnMap()" class="w-14 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 rounded-xl flex items-center justify-center transition-colors">
                        <span class="material-icons">search</span>
                    </button>
                </div>
                
                <!-- 說明 -->
                <div>
                    <textarea id="details" rows="3" placeholder="備註、訂位資訊..." class="w-full bg-zinc-800/50 text-white p-4 rounded-xl focus:outline-none focus:ring-1 focus:ring-zinc-500 placeholder-zinc-500 text-[17px] resize-none transition-all"></textarea>
                </div>

                <div class="pt-4 flex space-x-3">
                    <button type="button" id="delete-btn" class="hidden flex-1 bg-red-500/10 text-red-500 py-3.5 rounded-xl font-semibold text-[15px] hover:bg-red-500/20 transition-colors">
                        刪除
                    </button>
                    <button type="button" onclick="closeModal()" class="flex-1 bg-zinc-800 text-white py-3.5 rounded-xl font-semibold text-[15px] hover:bg-zinc-700 transition-colors">
                        取消
                    </button>
                    <button type="submit" class="flex-[2] bg-white text-black py-3.5 rounded-xl font-bold text-[15px] hover:bg-gray-200 transition-colors shadow-lg">
                        儲存
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 權限錯誤 Modal (Dark Mode) -->
    <div id="permission-modal" class="fixed inset-0 z-[70] flex items-center justify-center hidden p-4">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm"></div>
        <div class="relative bg-[#1c1c1e] text-white rounded-3xl w-full max-w-md p-6 shadow-2xl border border-white/10">
            <div class="flex items-center mb-4 text-red-400">
                <span class="material-icons mr-2">gpp_bad</span>
                <h3 class="font-bold text-lg">資料庫權限設定</h3>
            </div>
            <p class="text-zinc-400 text-sm mb-4 leading-relaxed">為了開啟跨裝置同步與分享功能，請務必更新您的 Firebase 安全規則，允許公開讀寫（或使用更進階的驗證）。</p>
            
            <div class="bg-black rounded-xl p-4 mb-4 border border-zinc-800">
                <pre id="rules-code" class="text-green-400 text-xs overflow-x-auto font-mono whitespace-pre-wrap break-all">rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // 允許知道 ID 的人讀寫該行程
    match /artifacts/{appId}/users/{userId}/{document=**} {
      allow read, write: if true;
    }
  }
}</pre>
            </div>
            
            <div class="flex space-x-3">
                <button id="copy-rules-btn" onclick="copyRules()" class="flex-1 bg-zinc-800 hover:bg-zinc-700 text-white py-3 rounded-xl text-sm font-medium transition-colors">
                    複製代碼
                </button>
                <button onclick="closePermissionModal()" class="flex-1 bg-white text-black py-3 rounded-xl text-sm font-bold hover:bg-gray-200 transition-colors">
                    我已完成
                </button>
            </div>
        </div>
    </div>

</body>
</html>
