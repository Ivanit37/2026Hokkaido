<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åŒ—æµ·ç›œ</title>
    <!-- ç¶²ç«™åœ–ç¤º (Favicon) -->
    <link rel="icon" href="hokicon.jpg" type="image/jpeg">
    
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- å¼•å…¥ Google Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot, getDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // è¨­å®š Firebase Debug Log
        setLogLevel('silent'); 

        // å…¨åŸŸè®Šæ•¸
        const appId = typeof __app_id !== 'undefined' ? __app_id : '2026hokkaido';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; 
        
        // --- Firebase è¨­å®š ---
        const firebaseConfig = {
            apiKey: "AIzaSyBsHR53LDslQL5D9_l79wJA7NUOe8mrCe8",
            authDomain: "hokkaido-fc132.firebaseapp.com",
            projectId: "hokkaido-fc132",
            storageBucket: "hokkaido-fc132.firebasestorage.app",
            messagingSenderId: "107783904784",
            appId: "1:107783904784:web:3635a0aca3fd8478a03495",
        };
        
        let app, db, auth;
        let userId = null;
        let currentDataId = null; 
        let isAuthReady = false;

        // UI è®Šæ•¸ (å»¶å¾Œåˆå§‹åŒ–)
        let modal, modalForm, modalTitle;
        let editingIndex = null; 
        
        // åˆå§‹åŒ– Firebase
        if (Object.keys(firebaseConfig).length > 0) {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
            } catch (e) {
                console.error("Firebase Initialization Error:", e);
                // é€™è£¡é‚„ä¸èƒ½å‘¼å« UI ç›¸é—œå‡½å¼ï¼Œå› ç‚º DOM å¯èƒ½é‚„æ²’å¥½
            }
        } else {
            console.error("Firebase Configuration is missing.");
        }

        /**
         * é¡¯ç¤ºç‹€æ…‹è¨Šæ¯çš„è¼”åŠ©å‡½å¼ (iOS Toast é¢¨æ ¼)
         */
        const showStatusMessage = (htmlContent, isError = false) => {
            const statusMsg = document.getElementById('status-message');
            if (statusMsg) {
                statusMsg.innerHTML = htmlContent;
                statusMsg.classList.remove('hidden', 'opacity-0', 'translate-y-4');
                
                // æ ¹æ“šé¡å‹è¨­å®šæ¨£å¼
                if (isError) {
                    statusMsg.className = "fixed bottom-8 left-1/2 transform -translate-x-1/2 bg-red-500/90 backdrop-blur-md text-white text-[15px] font-medium px-6 py-3 rounded-full shadow-2xl z-50 transition-all duration-300";
                } else {
                    statusMsg.className = "fixed bottom-8 left-1/2 transform -translate-x-1/2 bg-zinc-800/90 backdrop-blur-md text-white text-[15px] font-medium px-6 py-3 rounded-full shadow-2xl z-50 transition-all duration-300 border border-white/10";
                }

                // 3ç§’å¾Œè‡ªå‹•æ¶ˆå¤±
                setTimeout(() => {
                    statusMsg.classList.add('opacity-0', 'translate-y-4');
                    setTimeout(() => statusMsg.classList.add('hidden'), 300);
                }, 3000);
            }
        };

        const showPermissionErrorModal = () => {
            const modal = document.getElementById('permission-modal');
            if(modal) modal.classList.remove('hidden');
        };

        const initFirebase = async () => {
            if (!app || !db || !auth) return;

            try {
                if (initialAuthToken) {
                    try {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } catch (tokenError) {
                        await signInAnonymously(auth);
                    }
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase Auth failed:", error);
                showStatusMessage(`ç™»å…¥å¤±æ•—: ${error.message}`, true);
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    
                    // 1. æª¢æŸ¥ç¶²å€åƒæ•¸ (?trip=xxx) - æ–°å¢åŠŸèƒ½
                    const urlParams = new URLSearchParams(window.location.search);
                    const linkTripId = urlParams.get('trip');

                    // 2. æª¢æŸ¥ LocalStorage
                    const savedTripId = localStorage.getItem('custom_trip_id');
                    
                    // å„ªå…ˆç´š: ç¶²å€åƒæ•¸ > LocalStorage > åŸç”Ÿ UserID
                    if (linkTripId) {
                        currentDataId = linkTripId;
                        // å¦‚æœç¶²å€æœ‰å¸¶åƒæ•¸ï¼Œé †ä¾¿å­˜å…¥ LocalStorageï¼Œé€™æ¨£ä¸‹æ¬¡æ²’å¸¶åƒæ•¸ä¹Ÿèƒ½è¨˜ä½
                        localStorage.setItem('custom_trip_id', linkTripId);
                    } else {
                        currentDataId = savedTripId || userId;
                    }
                    
                    updateSyncUI(); // æ›´æ–°ä»‹é¢é¡¯ç¤º ID
                    loadItinerary(window.selectedDate);
                } else {
                    userId = null;
                    isAuthReady = true;
                }
            });
        };

        const getItineraryCollectionPath = () => {
            if (!currentDataId) return null;
            // ä½¿ç”¨ currentDataId è€Œä¸æ˜¯ userIdï¼Œå¯¦ç¾è·¨å¸³è™Ÿå­˜å–
            return `artifacts/${appId}/users/${currentDataId}/hokkaido_itinerary`;
        };

        // --- åœ°åœ–ç›¸é—œ Helper ---
        const openMapAppSearch = (query) => {
             const isAndroid = /Android/i.test(navigator.userAgent);
             const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
             const isMobile = isAndroid || isIOS;
             const encodedQuery = encodeURIComponent(query);

             if (isMobile) {
                 if (isAndroid) {
                     // Android: ä½¿ç”¨ geo intent ç›´æ¥å‘¼å«åœ°åœ–æ‡‰ç”¨ç¨‹å¼
                     window.location.href = `geo:0,0?q=${encodedQuery}`;
                 } else {
                     // iOS: ä½¿ç”¨ maps.google.com æ ¼å¼ä¸¦é€é location.href è§¸ç™¼
                     // é€™ç¨®æ–¹å¼æ¯” window.open æ›´å®¹æ˜“è¢« iOS è­˜åˆ¥ç‚º Universal Link ä¸¦é–‹å•Ÿ App
                     window.location.href = `https://maps.google.com/?q=${encodedQuery}`;
                 }
             } else {
                 // é›»è…¦ç‰ˆï¼šé–‹æ–°åˆ†é 
                 window.open(`https://www.google.com/maps/search/?api=1&query=${encodedQuery}`, '_blank');
             }
        };

        window.openGoogleMapsRoute = () => {
            const items = window.currentItinerary || [];
            const locations = items
                .filter(item => item.location && item.location.trim() !== "")
                .sort((a, b) => (a.time || '').localeCompare(b.time || ''))
                .map(item => item.location.trim());

            if (locations.length === 0) { 
                showStatusMessage("è¡Œç¨‹ä¸­æ²’æœ‰åœ°é»è³‡è¨Š", true); 
                return; 
            }

            let url = "";
            if (locations.length === 1) {
                const query = encodeURIComponent(locations[0]);
                url = `https://www.google.com/maps/search/?api=1&query=${query}`;
            } else {
                const origin = encodeURIComponent(locations[0]);
                const destination = encodeURIComponent(locations[locations.length - 1]);
                let waypoints = "";
                if (locations.length > 2) {
                    const waypointList = locations.slice(1, locations.length - 1).map(loc => encodeURIComponent(loc));
                    waypoints = `&waypoints=${waypointList.join('|')}`;
                }
                url = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}${waypoints}`;
            }

            // é‡å°è·¯ç·šè¦åŠƒï¼Œæ‰‹æ©Ÿç‰ˆåŒæ¨£ä½¿ç”¨ location.href å˜—è©¦å–šèµ· App
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            if (isMobile) {
                window.location.href = url;
            } else {
                window.open(url, '_blank');
            }
        };

        window.searchLocationOnMap = () => {
            const locationVal = document.getElementById('location').value.trim();
            if (locationVal) {
                openMapAppSearch(locationVal);
            } else {
                showStatusMessage("è«‹å…ˆè¼¸å…¥åœ°é»é—œéµå­—", true);
            }
        };

        // æ–°å¢ï¼šå°‹æ‰¾é™„è¿‘ä¾¿åˆ©åº— (æœ€ä½³åŒ– App é–‹å•Ÿé«”é©—)
        window.searchNearbyCVS = () => {
            openMapAppSearch('convenience store');
        };

        const updateFlightInfo = (date) => {
            const flightCard = document.getElementById('flight-info-card');
            if (!flightCard) return;

            flightCard.classList.add('hidden');
            
            if (date === '01/04') {
                renderFlightCard({
                    flightNo: 'HB008', airline: 'GBA', depCity: 'HKG', arrCity: 'CTS',
                    depTime: '09:15', arrTime: '15:00', link: 'https://www.flightradar24.com/data/flights/hb8'
                });
                flightCard.classList.remove('hidden');
            } else if (date === '01/11') {
                renderFlightCard({
                    flightNo: 'HB009', airline: 'GBA', depCity: 'CTS', arrCity: 'HKG',
                    depTime: '16:00', arrTime: '21:15', link: 'https://www.flightradar24.com/data/flights/hb9'
                });
                flightCard.classList.remove('hidden');
            }
        };

        const renderFlightCard = (data) => {
            const container = document.getElementById('flight-info-card');
            if(!container) return;

            container.innerHTML = `
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center space-x-2">
                        <span class="material-icons text-white/70 text-sm rotate-90">flight</span>
                        <span class="font-semibold text-white tracking-wide">${data.flightNo}</span>
                    </div>
                    <span class="text-[11px] font-bold bg-white text-black px-2 py-0.5 rounded-full">${data.airline}</span>
                </div>
                
                <div class="flex justify-between items-center text-center mb-5 relative">
                    <!-- é€£æ¥ç·š -->
                    <div class="absolute top-1/2 left-10 right-10 h-[1px] bg-zinc-700 -z-10"></div>

                    <div class="bg-[#1c1c1e] px-2 z-10">
                        <div class="text-[32px] font-light text-white tracking-tight">${data.depTime}</div>
                        <div class="text-[13px] text-zinc-500 font-medium mt-0.5 tracking-wide">${data.depCity}</div>
                    </div>
                    
                    <div class="bg-[#1c1c1e] px-2 z-10">
                        <div class="text-[32px] font-light text-white tracking-tight">${data.arrTime}</div>
                        <div class="text-[13px] text-zinc-500 font-medium mt-0.5 tracking-wide">${data.arrCity}</div>
                    </div>
                </div>

                <a href="${data.link}" target="_blank" class="block w-full text-center bg-zinc-800 hover:bg-zinc-700 text-white text-[13px] font-medium py-3 rounded-xl transition-all active:scale-[0.98]">
                    æŸ¥çœ‹èˆªç­å‹•æ…‹
                </a>
            `;
        };

        // è¨ˆç®—çµæŸæ™‚é–“çš„è¼”åŠ©å‡½å¼
        const calculateEndTime = (startTime, durationMinutes) => {
            if (!startTime || !durationMinutes) return null;
            const [hours, minutes] = startTime.split(':').map(Number);
            const totalMinutes = hours * 60 + minutes + parseInt(durationMinutes);
            const endHours = Math.floor(totalMinutes / 60) % 24;
            const endMins = totalMinutes % 60;
            return `${String(endHours).padStart(2, '0')}:${String(endMins).padStart(2, '0')}`;
        };
        
        // è¼”åŠ©ï¼šè¨ˆç®—å…©å€‹æ™‚é–“é»çš„åˆ†é˜å·®
        const calculateMinutesDiff = (start, end) => {
            if (!start || !end) return 0;
            const [sH, sM] = start.split(':').map(Number);
            const [eH, eM] = end.split(':').map(Number);
            const sTotal = sH * 60 + sM;
            const eTotal = eH * 60 + eM;
            // å‡è¨­éƒ½æ˜¯ç•¶å¤©ï¼Œè‹¥è·¨æ—¥(diff < 0)å‰‡+24hï¼Œä½†é€šå¸¸è¡Œç¨‹æ˜¯æŒ‰é †åºæ’
            let diff = eTotal - sTotal;
            if (diff < 0) diff += 1440; 
            return diff;
        };

        const loadItinerary = (date) => {
            const itineraryContainer = document.getElementById('itinerary-list');
            if(!itineraryContainer) return;

            itineraryContainer.innerHTML = '<div class="text-zinc-500 text-center py-10 text-[15px]">è¼‰å…¥ä¸­...</div>';

            // éœ€è¦æ¸…é™¤èˆŠçš„ç›£è½å™¨ï¼Œå› ç‚º DataId å¯èƒ½è®Šäº†
            if (window.itineraryUnsubscribe) {
                window.itineraryUnsubscribe();
                window.itineraryUnsubscribe = null;
            }

            if (!isAuthReady || !currentDataId) return;
            const path = getItineraryCollectionPath();
            if (!path) return;

            const docId = date.replace('/', '-'); 
            const docRef = doc(db, path, docId);
            
            window.itineraryUnsubscribe = onSnapshot(docRef, (docSnap) => {
                const itineraryList = docSnap.exists() ? docSnap.data().items : [];
                window.currentItinerary = itineraryList;
                renderItinerary(itineraryList);
                updateMapButtonState(itineraryList);
            }, (error) => {
                console.error("Error:", error);
                if (error.code === 'permission-denied') showPermissionErrorModal();
                else if (error.message.includes('offline')) showStatusMessage("é›¢ç·šæ¨¡å¼ - ç„¡æ³•é€£æ¥è³‡æ–™åº«", true);
            });
        };

        const updateMapButtonState = (items) => {
            const btn = document.getElementById('google-map-btn');
            if(!btn) return;
            const hasLocations = items.some(item => item.location && item.location.trim() !== "");
            
            if (hasLocations) {
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
                btn.disabled = false;
            } else {
                btn.classList.add('opacity-50', 'cursor-not-allowed');
                btn.disabled = true;
            }
        };

        const renderItinerary = (items) => {
            const itineraryContainer = document.getElementById('itinerary-list');
            if(!itineraryContainer) return;
            itineraryContainer.innerHTML = '';

            if (items.length === 0) {
                itineraryContainer.innerHTML = `
                    <div class="text-center py-20">
                        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-zinc-900 mb-4">
                            <span class="material-icons text-zinc-600 text-2xl">calendar_today</span>
                        </div>
                        <p class="text-zinc-500 text-[15px]">æœ¬æ—¥å°šç„¡è¡Œç¨‹</p>
                    </div>
                `;
                return;
            }

            items.sort((a, b) => (a.time || '').localeCompare(b.time || ''));

            items.forEach((item, index) => {
                let timeDisplay = item.time || '--:--';
                let durationDisplay = '';
                let calculatedDuration = item.duration; // é è¨­ä½¿ç”¨æ‰‹å‹•è¼¸å…¥çš„

                // å¦‚æœæ²’æœ‰æ‰‹å‹•è¼¸å…¥æ™‚é–“ï¼Œå˜—è©¦ä½¿ç”¨ä¸‹ä¸€å€‹è¡Œç¨‹çš„æ™‚é–“ä¾†è¨ˆç®—
                if (!calculatedDuration && index < items.length - 1) {
                    const nextItem = items[index + 1];
                    if (item.time && nextItem.time) {
                        const diff = calculateMinutesDiff(item.time, nextItem.time);
                        if (diff > 0) {
                            calculatedDuration = diff;
                        }
                    }
                }

                // æ ¹æ“šæœ€çµ‚çš„ Duration è¨ˆç®—é¡¯ç¤ºå­—ä¸²
                if (item.time && calculatedDuration) {
                    const endTime = calculateEndTime(item.time, calculatedDuration);
                    if (endTime) {
                        timeDisplay = `${item.time} - ${endTime}`;
                    }
                    // é¡¯ç¤ºåˆ†é˜æ•¸ (è‹¥æ˜¯è‡ªå‹•è¨ˆç®—çš„ï¼Œæ¨£å¼å¯ä»¥å¾®èª¿ï¼Œé€™è£¡ä¿æŒä¸€è‡´)
                    durationDisplay = `<span class="text-[13px] text-zinc-500 font-normal ml-2">(${calculatedDuration} min)</span>`;
                }


                const card = document.createElement('div');
                // iOS Card Style: Dark Gray Background, No Border, Rounded-2xl
                card.className = 'ios-card bg-[#1c1c1e] p-5 rounded-2xl mb-4 transition-transform duration-200 active:scale-[0.98] cursor-pointer group relative overflow-hidden';
                
                const locationDisplay = item.location ? 
                    `<div class="flex items-center mt-2 text-zinc-500">
                        <span class="material-icons text-[14px] mr-1">place</span>
                        <span class="text-[13px] font-medium">${item.location}</span>
                     </div>` : '';

                // å³ä¸Šè§’æ“ä½œæŒ‰éˆ• (é è¨­éš±è—ï¼Œé»æ“Šæˆ– hover é¡¯ç¤º)
                const actionsHtml = `
                    <div class="absolute top-4 right-4 flex space-x-2">
                        ${item.location ? `
                        <button class="map-item-btn w-8 h-8 flex items-center justify-center rounded-full bg-zinc-800 text-white hover:bg-zinc-700 transition-colors" title="åœ°åœ–">
                            <span class="material-icons text-[16px]">map</span>
                        </button>` : ''}
                        <button class="edit-btn w-8 h-8 flex items-center justify-center rounded-full bg-zinc-800 text-white hover:bg-zinc-700 transition-colors" data-index="${index}" title="ç·¨è¼¯">
                            <span class="material-icons text-[16px]">edit</span>
                        </button>
                    </div>
                `;

                card.innerHTML = `
                    <div class="flex items-start">
                        <!-- æ™‚é–“è»¸åœ“é»èˆ‡ç·šæ¢æ˜¯é€éå¤–éƒ¨ CSS è™•ç†ï¼Œé€™è£¡åªä¿ç•™å…§å®¹ -->
                        <div class="flex-grow pr-12"> <!-- pr-12 ç•™ç©ºé–“çµ¦æŒ‰éˆ• -->
                            <p class="text-[15px] font-semibold text-zinc-400 tracking-wide mb-1 font-numeric">
                                ${timeDisplay}${durationDisplay}
                            </p>
                            <h3 class="text-[17px] font-semibold text-white leading-tight">
                                ${item.activity || 'æœªå‘½åæ´»å‹•'}
                            </h3>
                            ${locationDisplay}
                            ${item.details ? `<p class="text-[15px] text-zinc-400 mt-3 leading-relaxed border-t border-zinc-800/50 pt-3">${item.details}</p>` : ''}
                        </div>
                        ${actionsHtml}
                    </div>
                `;
                
                card.addEventListener('click', (e) => {
                    // å¦‚æœé»æ“Šçš„æ˜¯æŒ‰éˆ•ï¼Œä¸è§¸ç™¼å¡ç‰‡é»æ“Š
                    if(e.target.closest('button')) return;
                    openEditModal(index);
                });

                const editBtn = card.querySelector('.edit-btn');
                if (editBtn) editBtn.addEventListener('click', (e) => { e.stopPropagation(); openEditModal(index); });
                
                const mapBtn = card.querySelector('.map-item-btn');
                if (mapBtn) mapBtn.addEventListener('click', (e) => { 
                    e.stopPropagation(); 
                    openMapAppSearch(item.location);
                });

                itineraryContainer.appendChild(card);
            });
        };

        const saveItinerary = async (date, items) => {
            if (!isAuthReady || !currentDataId) { showStatusMessage('éŒ¯èª¤ï¼šå°šæœªå°±ç·’', true); return; }
            const path = getItineraryCollectionPath();
            if (!path) return;
            const docId = date.replace('/', '-'); 
            const docRef = doc(db, path, docId);
            try {
                await setDoc(docRef, { items: items }, { merge: true });
            } catch (error) {
                if (error.code === 'permission-denied') showPermissionErrorModal();
                else showStatusMessage(`å„²å­˜å¤±æ•—: ${error.message}`, true);
            }
        };

        // --- Sync Logic ---
        window.openSyncModal = () => {
            const modal = document.getElementById('sync-modal');
            if(!modal) return;
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.querySelector('.modal-content').classList.remove('scale-95', 'opacity-0');
                modal.querySelector('.modal-content').classList.add('scale-100', 'opacity-100');
            }, 10);
            
            // å¡«å…¥ç•¶å‰ ID
            const idInput = document.getElementById('current-trip-id');
            if(idInput) idInput.value = currentDataId || 'Loading...';
        };

        window.closeSyncModal = () => {
            const modal = document.getElementById('sync-modal');
            if(!modal) return;
            const content = modal.querySelector('.modal-content');
            content.classList.remove('scale-100', 'opacity-100');
            content.classList.add('scale-95', 'opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 200);
        };

        /**
         * åŸ·è¡Œè¤‡è£½çš„é€šç”¨å‡½å¼ï¼Œè‡ªå‹•è™•ç†æ¬Šé™å•é¡Œ
         */
        const executeCopy = (text, successMessage) => {
            // æ–¹æ³•ï¼šä½¿ç”¨ execCommand å‚™æ¡ˆ (ç›¸å®¹æ€§æœ€é«˜ï¼Œé¿å… iFrame æ¬Šé™å•é¡Œ)
            const textArea = document.createElement("textarea");
            textArea.value = text;
            
            // ç¢ºä¿å…ƒç´ ä¸å¯è¦‹ä½†å­˜åœ¨æ–¼ DOM
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            textArea.style.top = "0";
            document.body.appendChild(textArea);
            
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showStatusMessage(successMessage);
                } else {
                    showStatusMessage("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½", true);
                }
            } catch (err) {
                console.error('Fallback copy error:', err);
                showStatusMessage("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½", true);
            }
            
            document.body.removeChild(textArea);
        };

        window.copyTripId = () => {
            const idInput = document.getElementById('current-trip-id');
            if(idInput) executeCopy(idInput.value, "å·²è¤‡è£½è¡Œç¨‹ä»£ç¢¼");
        };
        
        // æ–°å¢ï¼šè¤‡è£½å®Œæ•´è¡Œç¨‹é€£çµ
        window.copyTripLink = () => {
            const idInput = document.getElementById('current-trip-id');
            if (!idInput) return;
            const id = idInput.value;
            // ç¢ºä¿ç¶²å€æ­£ç¢ºï¼ŒåŠ ä¸Š ?trip=ID
            const url = `${window.location.origin}${window.location.pathname}?trip=${id}`;
            executeCopy(url, "å·²è¤‡è£½è¡Œç¨‹é€£çµ");
        };

        window.copyRules = () => {
            const rulesText = document.getElementById('rules-code');
            if(rulesText) executeCopy(rulesText.innerText, "å·²è¤‡è£½è¦å‰‡ä»£ç¢¼");
        };

        window.loadSharedTrip = () => {
            const idInput = document.getElementById('shared-trip-id');
            if(!idInput) return;
            const inputId = idInput.value.trim();

            if (!inputId) {
                showStatusMessage("è«‹è¼¸å…¥è¡Œç¨‹ä»£ç¢¼", true);
                return;
            }
            
            // å„²å­˜åˆ° localStorage ä¸¦æ›´æ–°ç‹€æ…‹
            localStorage.setItem('custom_trip_id', inputId);
            currentDataId = inputId;
            updateSyncUI();
            
            // é‡æ–°è¼‰å…¥è³‡æ–™
            loadItinerary(window.selectedDate);
            closeSyncModal();
            showStatusMessage("å·²åˆ‡æ›è‡³å…±äº«è¡Œç¨‹");
        };

        window.resetToMyTrip = () => {
            localStorage.removeItem('custom_trip_id');
            currentDataId = userId;
            updateSyncUI();
            loadItinerary(window.selectedDate);
            closeSyncModal();
            showStatusMessage("å·²åˆ‡æ›å›æˆ‘çš„è¡Œç¨‹");
        };

        const updateSyncUI = () => {
            // æ›´æ–° UI é¡¯ç¤ºç›®å‰æ˜¯å¦åœ¨å…±äº«æ¨¡å¼
            // é€™è£¡å¯ä»¥åšä¸€äº›è¦–è¦ºä¸Šçš„è®ŠåŒ–ï¼Œç›®å‰å…ˆä¿æŒç°¡å–®
            console.log("Current Data ID:", currentDataId);
        };

        // --- Modal ---
        
        window.openAddModal = () => {
            editingIndex = null;
            if(modalTitle) modalTitle.textContent = 'æ–°å¢è¡Œç¨‹';
            if(modalForm) modalForm.reset();
            openModalAnimation();
        };

        const openEditModal = (index) => {
            editingIndex = index;
            if(modalTitle) modalTitle.textContent = 'ç·¨è¼¯è¡Œç¨‹';
            const item = window.currentItinerary[index];
            
            const setVal = (id, val) => {
                const el = document.getElementById(id);
                if(el) el.value = val;
            };

            setVal('time', item.time || '');
            setVal('activity', item.activity || '');
            setVal('location', item.location || '');
            setVal('details', item.details || '');
            setVal('duration', item.duration || ''); // æ–°å¢ï¼šè¨­å®šåœç•™æ™‚é–“
            
            const deleteBtn = document.getElementById('delete-btn');
            if(deleteBtn) deleteBtn.classList.remove('hidden');
            openModalAnimation();
        };

        const openModalAnimation = () => {
            if(!modal) return;
            modal.classList.remove('hidden');
            // ç°¡å–®çš„æ·¡å…¥å‹•ç•«
            setTimeout(() => {
                modal.querySelector('.modal-content').classList.remove('scale-95', 'opacity-0');
                modal.querySelector('.modal-content').classList.add('scale-100', 'opacity-100');
            }, 10);
        };

        window.closeModal = () => {
            if(!modal) return;
            const content = modal.querySelector('.modal-content');
            content.classList.remove('scale-100', 'opacity-100');
            content.classList.add('scale-95', 'opacity-0');
            
            setTimeout(() => {
                modal.classList.add('hidden');
                const deleteBtn = document.getElementById('delete-btn');
                if(deleteBtn) deleteBtn.classList.add('hidden');
                if(modalForm) modalForm.reset();
            }, 200);
        };

        window.closePermissionModal = () => {
             const modal = document.getElementById('permission-modal');
             if(modal) modal.classList.add('hidden');
        };

        // --- Date Logic ---
        const dates = ["01/04", "01/05", "01/06", "01/07", "01/08", "01/09", "01/10", "01/11"];
        window.selectedDate = dates[0]; 

        window.selectDate = (date) => {
            if (window.itineraryUnsubscribe) window.itineraryUnsubscribe();
            window.selectedDate = date;
            
            // iOS Segment Control Style Update
            document.querySelectorAll('.date-btn').forEach(btn => {
                btn.classList.remove('bg-white', 'text-black', 'shadow-md');
                btn.classList.add('text-zinc-500', 'hover:text-zinc-300');
            });
            const activeBtn = document.getElementById(`date-${date.replace('/', '-')}`);
            if(activeBtn) {
                activeBtn.classList.remove('text-zinc-500', 'hover:text-zinc-300');
                activeBtn.classList.add('bg-white', 'text-black', 'shadow-md');
            }

            // document.getElementById('current-date-title').textContent = `${date} è¡Œç¨‹`;
            updateFlightInfo(date);
            if (isAuthReady) loadItinerary(date);
        };

        // DOMContentLoaded: ç¢ºä¿ DOM æº–å‚™å¥½å†åŸ·è¡Œ UI ç¶å®š
        document.addEventListener('DOMContentLoaded', () => {
            // åˆå§‹åŒ– UI å…ƒç´ 
            modal = document.getElementById('itinerary-modal');
            modalForm = document.getElementById('itinerary-form');
            modalTitle = document.getElementById('modal-title');
            
            // ç¶å®š Event Listeners
            if (modalForm) {
                modalForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const getVal = (id) => {
                        const el = document.getElementById(id);
                        return el ? el.value.trim() : '';
                    };

                    const time = getVal('time');
                    const duration = getVal('duration'); // æ–°å¢ï¼šå–å¾—åœç•™æ™‚é–“
                    const activity = getVal('activity');
                    const location = getVal('location');
                    const details = getVal('details');
                    
                    if (!activity) { showStatusMessage('è«‹è¼¸å…¥æ´»å‹•åç¨±', true); return; }
                    
                    const newItem = { 
                        time, duration, activity, location, details, 
                        id: editingIndex !== null ? window.currentItinerary[editingIndex].id : crypto.randomUUID() 
                    };
                    
                    let updatedItems = [...(window.currentItinerary || [])];
                    if (editingIndex !== null) { updatedItems[editingIndex] = newItem; } else { updatedItems.push(newItem); }

                    await saveItinerary(window.selectedDate, updatedItems);
                    window.closeModal();
                });
            }

            const deleteBtn = document.getElementById('delete-btn');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', async () => {
                    if (editingIndex !== null) {
                        if (confirm("ç¢ºå®šè¦åˆªé™¤æ­¤è¡Œç¨‹å—ï¼Ÿ")) {
                            const updatedItems = [...(window.currentItinerary || [])];
                            updatedItems.splice(editingIndex, 1);
                            await saveItinerary(window.selectedDate, updatedItems);
                            window.closeModal();
                        }
                    }
                });
            }

            const dateNav = document.getElementById('date-nav');
            if (dateNav) {
                dates.forEach(date => {
                    const btn = document.createElement('button');
                    btn.id = `date-${date.replace('/', '-')}`;
                    // iOS Pill Style
                    btn.className = `date-btn px-5 py-2 rounded-full text-[15px] font-semibold transition-all duration-300 ease-out whitespace-nowrap`;
                    btn.innerHTML = `<span class="opacity-60 text-[11px] block leading-none mb-0.5">${date.split('/')[0]}æœˆ</span><span class="text-[17px] block leading-none tracking-tight">${date.split('/')[1]}</span>`;
                    btn.onclick = () => window.selectDate(date);
                    dateNav.appendChild(btn);
                });
            }
            
            // åˆå§‹åŒ–é è¨­é¸æ“‡
            window.selectDate(window.selectedDate); 
            initFirebase();
        });
    </script>

    <style>
        /* iOS æ·±è‰²æ¨¡å¼å­—é«”è¨­å®š */
        body {
            /* å„ªå…ˆä½¿ç”¨ Apple ç³»çµ±å­—é«”ï¼Œä¸¦æŒ‡å®š PingFang TC ä½œç‚ºç¹ä¸­é¦–é¸ */
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "PingFang TC", "Hiragino Sans GB", "Microsoft JhengHei", "Helvetica Neue", Helvetica, Arial, sans-serif;
            background-color: #000000;
            color: #ffffff;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* æ•¸å­—å­—é«”å„ªåŒ– (ä½¿ç”¨ SF Pro çš„æ•¸å­—æ¨£å¼) */
        .font-numeric {
            font-variant-numeric: tabular-nums;
        }

        /* éš±è—æ²è»¸ä½†ä¿ç•™åŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* æ™‚é–“è»¸ç·šæ¢ (æ¥µç°¡ç°) */
        .itinerary-grid {
            position: relative;
            padding-left: 24px;
            padding-bottom: 40px;
        }
        .itinerary-grid::before {
            content: '';
            position: absolute;
            top: 20px;
            bottom: 20px;
            left: 7px; /* ç·šæ¢ä½ç½® */
            width: 2px;
            background-color: #27272a; /* zinc-800 */
            border-radius: 99px;
            z-index: 0;
        }
        
        /* æ™‚é–“è»¸åœ“é» (é»‘åº•ç™½é‚Š) */
        .ios-card::before {
            content: '';
            position: absolute;
            left: -21px; /* åœ“é»ä½ç½®ï¼Œç›¸å°æ–¼å¡ç‰‡ */
            top: 24px;
            width: 10px;
            height: 10px;
            background-color: #000000;
            border: 2px solid #52525b; /* zinc-600 */
            border-radius: 50%;
            z-index: 10;
            box-shadow: 0 0 0 4px #000000; /* å¤–éƒ¨é®ç½©è£½é€ é–“è·æ„Ÿ */
        }

        /* Modal å‹•ç•«èˆ‡æ¨£å¼ */
        .modal-content {
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        
        /* é‡å°è¼¸å…¥æ¡†çš„æ¨£å¼å„ªåŒ– */
        input[type="time"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            opacity: 0.6;
        }
    </style>
</head>
<body class="min-h-screen pb-20">

    <!-- Sticky Header (iOS Blur Effect) -->
    <div class="sticky top-0 z-40 bg-black/70 backdrop-blur-xl border-b border-white/5 pb-2">
        <div class="max-w-xl mx-auto px-4 pt-12 pb-2"> <!-- pt-12 for status bar space feeling -->
            <header class="flex justify-between items-end mb-4">
                <div class="flex items-center">
                    <img src="hokicon.jpg" alt="Icon" class="w-10 h-10 rounded-full mr-3 border-2 border-white/20">
                    <div>
                        <h1 class="text-[34px] font-bold tracking-tight text-white leading-tight">åŒ—æµ·ç›œ</h1>
                        <p class="text-zinc-500 text-[13px] font-medium mt-0.5 tracking-wide uppercase">2026 Winter Trip</p>
                    </div>
                </div>
                <!-- Sync Button -->
                <button onclick="openSyncModal()" class="w-9 h-9 bg-zinc-800 rounded-full flex items-center justify-center hover:bg-zinc-700 transition-colors">
                    <span class="material-icons text-white text-[18px]">cloud_sync</span>
                </button>
            </header>

            <!-- æ—¥æœŸå°èˆª (æ©«å‘æ²å‹•) -->
            <nav id="date-nav" class="flex space-x-2 overflow-x-auto no-scrollbar py-2 mask-linear"></nav>
        </div>
    </div>

    <div class="max-w-xl mx-auto px-4 pt-6">
        
        <!-- åŠŸèƒ½æŒ‰éˆ•å€ -->
        <div class="mb-6 grid grid-cols-1 gap-4">
            <button id="google-map-btn" onclick="openGoogleMapsRoute()" class="w-full bg-[#1c1c1e] active:bg-[#2c2c2e] text-white py-4 px-4 rounded-2xl flex items-center justify-center transition-all duration-200 group">
                <div class="w-8 h-8 rounded-full bg-zinc-800 flex items-center justify-center mr-3 group-active:scale-90 transition-transform">
                    <span class="material-icons text-[15px] text-white">map</span>
                </div>
                <span class="font-medium text-[15px]">æŸ¥çœ‹ä»Šæ—¥è·¯ç·š</span>
            </button>
            
            <!-- èˆªç­è³‡è¨Šå¡ç‰‡ -->
            <div id="flight-info-card" class="bg-[#1c1c1e] rounded-2xl p-5 hidden">
                <!-- JS å¡«å…… -->
            </div>
        </div>

        <!-- è¡Œç¨‹åˆ—è¡¨ -->
        <main>
            <!-- <h2 id="current-date-title" class="text-xl font-bold text-white mb-6 pl-1">ä»Šæ—¥è¡Œç¨‹</h2> -->
            <div id="itinerary-list" class="itinerary-grid">
                <!-- JS å¡«å…… -->
            </div>
        </main>

        <!-- ç‹€æ…‹è¨Šæ¯ (Toast) -->
        <div id="status-message" class="hidden transition-all duration-300 opacity-0 translate-y-4"></div>

        <!-- Convenience Store FAB -->
        <button onclick="searchNearbyCVS()" 
            class="fixed bottom-8 right-24 w-14 h-14 bg-[#1c1c1e] text-white rounded-full shadow-[0_8px_30px_rgb(0,0,0,0.5)] flex items-center justify-center active:scale-90 transition-transform duration-300 z-40 border border-zinc-700">
            <span class="text-2xl">ğŸª</span>
        </button>

        <!-- FAB (iOS style: White circle with black icon, high contrast) -->
        <button id="add-fab" onclick="openAddModal()"
            class="fixed bottom-8 right-6 w-14 h-14 bg-white text-black rounded-full shadow-[0_8px_30px_rgb(0,0,0,0.5)] flex items-center justify-center active:scale-90 transition-transform duration-300 z-40">
            <span class="material-icons text-3xl">add</span>
        </button>
    </div>

    <!-- Sync Modal -->
    <div id="sync-modal" class="fixed inset-0 z-[60] flex items-center justify-center hidden p-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeSyncModal()"></div>
        <div class="modal-content relative bg-[#1c1c1e] w-full max-w-sm rounded-3xl p-6 transform scale-95 opacity-0 shadow-2xl border border-white/10">
            <h3 class="text-xl font-bold text-white mb-4 text-center">è¡Œç¨‹åŒæ­¥ / åˆ†äº«</h3>
            
            <!-- Current ID -->
            <div class="mb-6">
                <label class="text-xs font-medium text-zinc-400 ml-1 block mb-2">ç›®å‰è¡Œç¨‹ (Current Trip)</label>
                <div class="flex space-x-2 mb-2">
                    <input type="text" id="current-trip-id" readonly class="flex-grow bg-zinc-900 text-white font-mono text-sm p-3 rounded-xl border border-zinc-800 focus:outline-none text-center">
                </div>
                <div class="flex space-x-2">
                     <button onclick="copyTripId()" class="flex-1 bg-zinc-800 text-white py-3 rounded-xl hover:bg-zinc-700 transition-colors text-xs font-medium">
                        è¤‡è£½ä»£ç¢¼
                    </button>
                    <button onclick="copyTripLink()" class="flex-1 bg-white text-black py-3 rounded-xl hover:bg-gray-200 transition-colors text-xs font-bold">
                        è¤‡è£½å®Œæ•´é€£çµ
                    </button>
                </div>
                <p class="text-[10px] text-zinc-500 mt-3 text-center">ä½¿ç”¨ã€Œå®Œæ•´é€£çµã€åŠ å…¥æˆ‘çš„æœ€æ„›ï¼Œä¸‹æ¬¡ç›´æ¥é»æ“Šå³å¯é€²å…¥ã€‚</p>
            </div>

            <div class="h-[1px] bg-zinc-800 w-full mb-6"></div>

            <!-- Join Trip -->
            <div class="mb-6">
                <label class="text-xs font-medium text-zinc-400 ml-1 block mb-2">è¼‰å…¥å…¶ä»–è¡Œç¨‹</label>
                <input type="text" id="shared-trip-id" placeholder="è¼¸å…¥è¡Œç¨‹ä»£ç¢¼..." class="w-full bg-zinc-800/50 text-white p-3 rounded-xl focus:outline-none focus:ring-1 focus:ring-white/20 mb-3">
                <button onclick="loadSharedTrip()" class="w-full bg-white text-black py-3 rounded-xl font-bold text-sm hover:bg-gray-200 transition-colors">
                    è¼‰å…¥è¡Œç¨‹
                </button>
            </div>

            <button onclick="resetToMyTrip()" class="w-full text-zinc-500 py-2 text-xs hover:text-white transition-colors">
                å›åˆ°æˆ‘çš„åŸå§‹è¡Œç¨‹
            </button>
        </div>
    </div>

    <!-- ç·¨è¼¯/æ–°å¢ Modal (iOS Sheet Style) -->
    <div id="itinerary-modal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center hidden">
        <!-- Backdrop -->
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeModal()"></div>
        
        <!-- Content -->
        <div class="modal-content relative bg-[#1c1c1e] w-full max-w-lg sm:rounded-3xl rounded-t-3xl p-6 sm:p-8 transform scale-95 opacity-0 shadow-2xl border-t border-white/10 sm:border-none">
            <!-- Handle bar for mobile feel -->
            <div class="w-10 h-1 bg-zinc-700 rounded-full mx-auto mb-6 sm:hidden"></div>

            <h3 id="modal-title" class="text-[22px] font-bold mb-6 text-white text-center">è¡Œç¨‹é …ç›®</h3>
            
            <form id="itinerary-form" class="space-y-5">
                <div class="flex space-x-3">
                    <!-- æ™‚é–“ -->
                    <div class="flex-1 bg-zinc-800/50 rounded-xl p-3 flex flex-col justify-center">
                        <label class="text-[13px] font-medium text-zinc-400 mb-1">é–‹å§‹æ™‚é–“</label>
                        <input type="time" id="time" class="bg-transparent text-white font-numeric text-[19px] focus:outline-none w-full">
                    </div>
                    
                    <!-- åœç•™æ™‚é–“ (æ–°å¢) -->
                    <div class="flex-1 bg-zinc-800/50 rounded-xl p-3 flex flex-col justify-center">
                        <label class="text-[13px] font-medium text-zinc-400 mb-1">åœç•™ (åˆ†é˜)</label>
                        <input type="number" id="duration" placeholder="60" class="bg-transparent text-white font-numeric text-[19px] focus:outline-none w-full placeholder-zinc-600">
                    </div>
                </div>
                
                <!-- æ´»å‹• -->
                <div>
                    <input type="text" id="activity" placeholder="æ´»å‹•åç¨±" class="w-full bg-zinc-800/50 text-white p-4 rounded-xl focus:outline-none focus:ring-1 focus:ring-zinc-500 placeholder-zinc-500 text-[17px] font-medium transition-all">
                </div>
                
                <!-- åœ°é» -->
                <div class="flex space-x-2">
                    <input type="text" id="location" placeholder="åœ°é» (é¸å¡«)" class="flex-grow bg-zinc-800/50 text-white p-4 rounded-xl focus:outline-none focus:ring-1 focus:ring-zinc-500 placeholder-zinc-500 text-[17px] transition-all">
                    <button type="button" onclick="searchLocationOnMap()" class="w-14 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 rounded-xl flex items-center justify-center transition-colors">
                        <span class="material-icons">search</span>
                    </button>
                </div>
                
                <!-- èªªæ˜ -->
                <div>
                    <textarea id="details" rows="3" placeholder="å‚™è¨»ã€è¨‚ä½è³‡è¨Š..." class="w-full bg-zinc-800/50 text-white p-4 rounded-xl focus:outline-none focus:ring-1 focus:ring-zinc-500 placeholder-zinc-500 text-[17px] resize-none transition-all"></textarea>
                </div>

                <div class="pt-4 flex space-x-3">
                    <button type="button" id="delete-btn" class="hidden flex-1 bg-red-500/10 text-red-500 py-3.5 rounded-xl font-semibold text-[15px] hover:bg-red-500/20 transition-colors">
                        åˆªé™¤
                    </button>
                    <button type="button" onclick="closeModal()" class="flex-1 bg-zinc-800 text-white py-3.5 rounded-xl font-semibold text-[15px] hover:bg-zinc-700 transition-colors">
                        å–æ¶ˆ
                    </button>
                    <button type="submit" class="flex-[2] bg-white text-black py-3.5 rounded-xl font-bold text-[15px] hover:bg-gray-200 transition-colors shadow-lg">
                        å„²å­˜
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- æ¬Šé™éŒ¯èª¤ Modal (Dark Mode) -->
    <div id="permission-modal" class="fixed inset-0 z-[70] flex items-center justify-center hidden p-4">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm"></div>
        <div class="relative bg-[#1c1c1e] text-white rounded-3xl w-full max-w-md p-6 shadow-2xl border border-white/10">
            <div class="flex items-center mb-4 text-red-400">
                <span class="material-icons mr-2">gpp_bad</span>
                <h3 class="font-bold text-lg">è³‡æ–™åº«æ¬Šé™è¨­å®š</h3>
            </div>
            <p class="text-zinc-400 text-sm mb-4 leading-relaxed">ç‚ºäº†é–‹å•Ÿè·¨è£ç½®åŒæ­¥èˆ‡åˆ†äº«åŠŸèƒ½ï¼Œè«‹å‹™å¿…æ›´æ–°æ‚¨çš„ Firebase å®‰å…¨è¦å‰‡ï¼Œå…è¨±å…¬é–‹è®€å¯«ï¼ˆæˆ–ä½¿ç”¨æ›´é€²éšçš„é©—è­‰ï¼‰ã€‚</p>
            
            <div class="bg-black rounded-xl p-4 mb-4 border border-zinc-800">
                <pre id="rules-code" class="text-green-400 text-xs overflow-x-auto font-mono whitespace-pre-wrap break-all">rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // å…è¨±çŸ¥é“ ID çš„äººè®€å¯«è©²è¡Œç¨‹
    match /artifacts/{appId}/users/{userId}/{document=**} {
      allow read, write: if true;
    }
  }
}</pre>
            </div>
            
            <div class="flex space-x-3">
                <button id="copy-rules-btn" onclick="copyRules()" class="flex-1 bg-zinc-800 hover:bg-zinc-700 text-white py-3 rounded-xl text-sm font-medium transition-colors">
                    è¤‡è£½ä»£ç¢¼
                </button>
                <button onclick="closePermissionModal()" class="flex-1 bg-white text-black py-3 rounded-xl text-sm font-bold hover:bg-gray-200 transition-colors">
                    æˆ‘å·²å®Œæˆ
                </button>
            </div>
        </div>
    </div>

</body>
</html>
